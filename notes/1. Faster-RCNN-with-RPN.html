<!DOCTYPE html>
<html>
  <head>
    <title>1. Faster-RCNN-with-RPN</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css"
    />

    <style>
      html body {
        background-image: url("https://github.com/mingqian-233/CV-Notes/blob/master/images/bg_2.jpeg?raw=true");
        background-size: cover;
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-position: center;
        position: relative;
      }
      html body::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: inherit;
        background-size: cover;
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-position: center;
        filter: blur(1px); /* 设置模糊效果 */
        z-index: -2;
      }
      html body::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.6); /* 白色蒙版 */
        z-index: -1;
      }
      code[class*="language-"],
      pre[class*="language-"] {
        color: #333;
        background: 0 0;
        font-family: Consolas, "Liberation Mono", Menlo, Courier, monospace;
        text-align: left;
        white-space: pre;
        word-spacing: normal;
        word-break: normal;
        word-wrap: normal;
        line-height: 1.4;
        -moz-tab-size: 8;
        -o-tab-size: 8;
        tab-size: 8;
        -webkit-hyphens: none;
        -moz-hyphens: none;
        -ms-hyphens: none;
        hyphens: none;
      }
      pre[class*="language-"] {
        padding: 0.8em;
        overflow: auto;
        border-radius: 3px;
        background: #f5f5f5;
      }
      :not(pre) > code[class*="language-"] {
        padding: 0.1em;
        border-radius: 0.3em;
        white-space: normal;
        background: #f5f5f5;
      }
      .token.blockquote,
      .token.comment {
        color: #969896;
      }
      .token.cdata {
        color: #183691;
      }
      .token.doctype,
      .token.macro.property,
      .token.punctuation,
      .token.variable {
        color: #333;
      }
      .token.builtin,
      .token.important,
      .token.keyword,
      .token.operator,
      .token.rule {
        color: #a71d5d;
      }
      .token.attr-value,
      .token.regex,
      .token.string,
      .token.url {
        color: #183691;
      }
      .token.atrule,
      .token.boolean,
      .token.code,
      .token.command,
      .token.constant,
      .token.entity,
      .token.number,
      .token.property,
      .token.symbol {
        color: #0086b3;
      }
      .token.prolog,
      .token.selector,
      .token.tag {
        color: #63a35c;
      }
      .token.attr-name,
      .token.class,
      .token.class-name,
      .token.function,
      .token.id,
      .token.namespace,
      .token.pseudo-class,
      .token.pseudo-element,
      .token.url-reference .token.variable {
        color: #795da3;
      }
      .token.entity {
        cursor: help;
      }
      .token.title,
      .token.title .token.punctuation {
        font-weight: 700;
        color: #1d3e81;
      }
      .token.list {
        color: #ed6a43;
      }
      .token.inserted {
        background-color: #eaffea;
        color: #55a532;
      }
      .token.deleted {
        background-color: #ffecec;
        color: #bd2c00;
      }
      .token.bold {
        font-weight: 700;
      }
      .token.italic {
        font-style: italic;
      }
      .language-json .token.property {
        color: #183691;
      }
      .language-markup .token.tag .token.punctuation {
        color: #333;
      }
      .language-css .token.function,
      code.language-css {
        color: #0086b3;
      }
      .language-yaml .token.atrule {
        color: #63a35c;
      }
      code.language-yaml {
        color: #183691;
      }
      .language-ruby .token.function {
        color: #333;
      }
      .language-markdown .token.url {
        color: #795da3;
      }
      .language-makefile .token.symbol {
        color: #795da3;
      }
      .language-makefile .token.variable {
        color: #183691;
      }
      .language-makefile .token.builtin {
        color: #0086b3;
      }
      .language-bash .token.keyword {
        color: #0086b3;
      }
      pre[data-line] {
        position: relative;
        padding: 1em 0 1em 3em;
      }
      pre[data-line] .line-highlight-wrapper {
        position: absolute;
        top: 0;
        left: 0;
        background-color: transparent;
        display: block;
        width: 100%;
      }
      pre[data-line] .line-highlight {
        position: absolute;
        left: 0;
        right: 0;
        padding: inherit 0;
        margin-top: 1em;
        background: hsla(24, 20%, 50%, 0.08);
        background: linear-gradient(
          to right,
          hsla(24, 20%, 50%, 0.1) 70%,
          hsla(24, 20%, 50%, 0)
        );
        pointer-events: none;
        line-height: inherit;
        white-space: pre;
      }
      pre[data-line] .line-highlight:before,
      pre[data-line] .line-highlight[data-end]:after {
        content: attr(data-start);
        position: absolute;
        top: 0.4em;
        left: 0.6em;
        min-width: 1em;
        padding: 0 0.5em;
        background-color: hsla(24, 20%, 50%, 0.4);
        color: #f4f1ef;
        font: bold 65%/1.5 sans-serif;
        text-align: center;
        vertical-align: 0.3em;
        border-radius: 999px;
        text-shadow: none;
        box-shadow: 0 1px #fff;
      }
      pre[data-line] .line-highlight[data-end]:after {
        content: attr(data-end);
        top: auto;
        bottom: 0.4em;
      }
      html body {
        font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans,
          sans-serif;
        font-size: 16px;
        line-height: 1.6;
        color: #333;
        background-color: #fff;
        overflow: initial;
        box-sizing: border-box;
        word-wrap: break-word;
      }
      html body > :first-child {
        margin-top: 0;
      }
      html body h1,
      html body h2,
      html body h3,
      html body h4,
      html body h5,
      html body h6 {
        line-height: 1.2;
        margin-top: 1em;
        margin-bottom: 16px;
        color: #000;
      }
      html body h1 {
        font-size: 2.25em;
        font-weight: 300;
        padding-bottom: 0.3em;
      }
      html body h2 {
        font-size: 1.75em;
        font-weight: 400;
        padding-bottom: 0.3em;
      }
      html body h3 {
        font-size: 1.5em;
        font-weight: 500;
      }
      html body h4 {
        font-size: 1.25em;
        font-weight: 600;
      }
      html body h5 {
        font-size: 1.1em;
        font-weight: 600;
      }
      html body h6 {
        font-size: 1em;
        font-weight: 600;
      }
      html body h1,
      html body h2,
      html body h3,
      html body h4,
      html body h5 {
        font-weight: 600;
      }
      html body h5 {
        font-size: 1em;
      }
      html body h6 {
        color: #5c5c5c;
      }
      html body strong {
        color: #000;
      }
      html body del {
        color: #5c5c5c;
      }
      html body a:not([href]) {
        color: inherit;
        text-decoration: none;
      }
      html body a {
        color: #08c;
        text-decoration: none;
      }
      html body a:hover {
        color: #00a3f5;
        text-decoration: none;
      }
      html body img {
        max-width: 100%;
      }
      html body > p {
        margin-top: 0;
        margin-bottom: 16px;
        word-wrap: break-word;
      }
      html body > ol,
      html body > ul {
        margin-bottom: 16px;
      }
      html body ol,
      html body ul {
        padding-left: 2em;
      }
      html body ol.no-list,
      html body ul.no-list {
        padding: 0;
        list-style-type: none;
      }
      html body ol ol,
      html body ol ul,
      html body ul ol,
      html body ul ul {
        margin-top: 0;
        margin-bottom: 0;
      }
      html body li {
        margin-bottom: 0;
      }
      html body li.task-list-item {
        list-style: none;
      }
      html body li > p {
        margin-top: 0;
        margin-bottom: 0;
      }
      html body .task-list-item-checkbox {
        margin: 0 0.2em 0.25em -1.8em;
        vertical-align: middle;
      }
      html body .task-list-item-checkbox:hover {
        cursor: pointer;
      }
      html body blockquote {
        margin: 16px 0;
        font-size: inherit;
        padding: 0 15px;
        color: #5c5c5c;
        background-color: #f0f0f0;
        border-left: 4px solid #d6d6d6;
      }
      html body blockquote > :first-child {
        margin-top: 0;
      }
      html body blockquote > :last-child {
        margin-bottom: 0;
      }
      html body hr {
        height: 4px;
        margin: 32px 0;
        background-color: #d6d6d6;
        border: 0 none;
      }
      html body table {
        margin: 10px 0 15px 0;
        border-collapse: collapse;
        border-spacing: 0;
        display: block;
        width: 100%;
        overflow: auto;
        word-break: normal;
        word-break: keep-all;
      }
      html body table th {
        font-weight: 700;
        color: #000;
      }
      html body table td,
      html body table th {
        border: 1px solid #d6d6d6;
        padding: 6px 13px;
      }
      html body dl {
        padding: 0;
      }
      html body dl dt {
        padding: 0;
        margin-top: 16px;
        font-size: 1em;
        font-style: italic;
        font-weight: 700;
      }
      html body dl dd {
        padding: 0 16px;
        margin-bottom: 16px;
      }
      html body code {
        font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
        font-size: 0.85em;
        color: #000;
        background-color: #f0f0f0;
        border-radius: 3px;
        padding: 0.2em 0;
      }
      html body code::after,
      html body code::before {
        letter-spacing: -0.2em;
        content: "\00a0";
      }
      html body pre > code {
        padding: 0;
        margin: 0;
        word-break: normal;
        white-space: pre;
        background: 0 0;
        border: 0;
      }
      html body .highlight {
        margin-bottom: 16px;
      }
      html body .highlight pre,
      html body pre {
        padding: 1em;
        overflow: auto;
        line-height: 1.45;
        border: #d6d6d6;
        border-radius: 3px;
      }
      html body .highlight pre {
        margin-bottom: 0;
        word-break: normal;
      }
      html body pre code,
      html body pre tt {
        display: inline;
        max-width: initial;
        padding: 0;
        margin: 0;
        overflow: initial;
        line-height: inherit;
        word-wrap: normal;
        background-color: transparent;
        border: 0;
      }
      html body pre code:after,
      html body pre code:before,
      html body pre tt:after,
      html body pre tt:before {
        content: normal;
      }
      html body blockquote,
      html body dl,
      html body ol,
      html body p,
      html body pre,
      html body ul {
        margin-top: 0;
        margin-bottom: 16px;
      }
      html body kbd {
        color: #000;
        border: 1px solid #d6d6d6;
        border-bottom: 2px solid #c7c7c7;
        padding: 2px 4px;
        background-color: #f0f0f0;
        border-radius: 3px;
      }
      @media print {
        html body {
          background-color: #fff;
        }
        html body h1,
        html body h2,
        html body h3,
        html body h4,
        html body h5,
        html body h6 {
          color: #000;
          page-break-after: avoid;
        }
        html body blockquote {
          color: #5c5c5c;
        }
        html body pre {
          page-break-inside: avoid;
        }
        html body table {
          display: table;
        }
        html body img {
          display: block;
          max-width: 100%;
          max-height: 100%;
        }
        html body code,
        html body pre {
          word-wrap: break-word;
          white-space: pre;
        }
      }
      .markdown-preview {
        width: 100%;
        height: 100%;
        box-sizing: border-box;
      }
      .markdown-preview ul {
        list-style: disc;
      }
      .markdown-preview ul ul {
        list-style: circle;
      }
      .markdown-preview ul ul ul {
        list-style: square;
      }
      .markdown-preview ol {
        list-style: decimal;
      }
      .markdown-preview ol ol,
      .markdown-preview ul ol {
        list-style-type: lower-roman;
      }
      .markdown-preview ol ol ol,
      .markdown-preview ol ul ol,
      .markdown-preview ul ol ol,
      .markdown-preview ul ul ol {
        list-style-type: lower-alpha;
      }
      .markdown-preview .newpage,
      .markdown-preview .pagebreak {
        page-break-before: always;
      }
      .markdown-preview pre.line-numbers {
        position: relative;
        padding-left: 3.8em;
        counter-reset: linenumber;
      }
      .markdown-preview pre.line-numbers > code {
        position: relative;
      }
      .markdown-preview pre.line-numbers .line-numbers-rows {
        position: absolute;
        pointer-events: none;
        top: 1em;
        font-size: 100%;
        left: 0;
        width: 3em;
        letter-spacing: -1px;
        border-right: 1px solid #999;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
      .markdown-preview pre.line-numbers .line-numbers-rows > span {
        pointer-events: none;
        display: block;
        counter-increment: linenumber;
      }
      .markdown-preview pre.line-numbers .line-numbers-rows > span:before {
        content: counter(linenumber);
        color: #999;
        display: block;
        padding-right: 0.8em;
        text-align: right;
      }
      .markdown-preview .mathjax-exps .MathJax_Display {
        text-align: center !important;
      }
      .markdown-preview:not([data-for="preview"])
        .code-chunk
        .code-chunk-btn-group {
        display: none;
      }
      .markdown-preview:not([data-for="preview"]) .code-chunk .status {
        display: none;
      }
      .markdown-preview:not([data-for="preview"]) .code-chunk .output-div {
        margin-bottom: 16px;
      }
      .markdown-preview .md-toc {
        padding: 0;
      }
      .markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link {
        display: inline;
        padding: 0.25rem 0;
      }
      .markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,
      .markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p {
        display: inline;
      }
      .markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link {
        font-weight: 800;
      }
      .scrollbar-style::-webkit-scrollbar {
        width: 8px;
      }
      .scrollbar-style::-webkit-scrollbar-track {
        border-radius: 10px;
        background-color: transparent;
      }
      .scrollbar-style::-webkit-scrollbar-thumb {
        border-radius: 5px;
        background-color: rgba(150, 150, 150, 0.66);
        border: 4px solid rgba(150, 150, 150, 0.66);
        background-clip: content-box;
      }
      html body[for="html-export"]:not([data-presentation-mode]) {
        position: relative;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        margin: 0;
        padding: 0;
        overflow: auto;
      }
      html
        body[for="html-export"]:not([data-presentation-mode])
        .markdown-preview {
        position: relative;
        top: 0;
        min-height: 100vh;
      }
      @media screen and (min-width: 914px) {
        html
          body[for="html-export"]:not([data-presentation-mode])
          .markdown-preview {
          padding: 2em calc(50% - 457px + 2em);
        }
      }
      @media screen and (max-width: 914px) {
        html
          body[for="html-export"]:not([data-presentation-mode])
          .markdown-preview {
          padding: 2em;
        }
      }
      @media screen and (max-width: 450px) {
        html
          body[for="html-export"]:not([data-presentation-mode])
          .markdown-preview {
          font-size: 14px !important;
          padding: 1em;
        }
      }
      @media print {
        html
          body[for="html-export"]:not([data-presentation-mode])
          #sidebar-toc-btn {
          display: none;
        }
      }
      html
        body[for="html-export"]:not([data-presentation-mode])
        #sidebar-toc-btn {
        position: fixed;
        bottom: 8px;
        left: 8px;
        font-size: 28px;
        cursor: pointer;
        color: inherit;
        z-index: 99;
        width: 32px;
        text-align: center;
        opacity: 0.4;
      }
      html
        body[for="html-export"]:not(
          [data-presentation-mode]
        )[html-show-sidebar-toc]
        #sidebar-toc-btn {
        opacity: 1;
      }
      html
        body[for="html-export"]:not(
          [data-presentation-mode]
        )[html-show-sidebar-toc]
        .md-sidebar-toc {
        position: fixed;
        top: 0;
        left: 0;
        width: 300px;
        height: 100%;
        padding: 32px 0 48px 0;
        font-size: 14px;
        box-shadow: 0 0 4px rgba(150, 150, 150, 0.33);
        box-sizing: border-box;
        overflow: auto;
        background-color: inherit;
      }
      html
        body[for="html-export"]:not(
          [data-presentation-mode]
        )[html-show-sidebar-toc]
        .md-sidebar-toc::-webkit-scrollbar {
        width: 8px;
      }
      html
        body[for="html-export"]:not(
          [data-presentation-mode]
        )[html-show-sidebar-toc]
        .md-sidebar-toc::-webkit-scrollbar-track {
        border-radius: 10px;
        background-color: transparent;
      }
      html
        body[for="html-export"]:not(
          [data-presentation-mode]
        )[html-show-sidebar-toc]
        .md-sidebar-toc::-webkit-scrollbar-thumb {
        border-radius: 5px;
        background-color: rgba(150, 150, 150, 0.66);
        border: 4px solid rgba(150, 150, 150, 0.66);
        background-clip: content-box;
      }
      html
        body[for="html-export"]:not(
          [data-presentation-mode]
        )[html-show-sidebar-toc]
        .md-sidebar-toc
        a {
        text-decoration: none;
      }
      html
        body[for="html-export"]:not(
          [data-presentation-mode]
        )[html-show-sidebar-toc]
        .md-sidebar-toc
        .md-toc {
        padding: 0 16px;
      }
      html
        body[for="html-export"]:not(
          [data-presentation-mode]
        )[html-show-sidebar-toc]
        .md-sidebar-toc
        .md-toc
        .md-toc-link-wrapper
        .md-toc-link {
        display: inline;
        padding: 0.25rem 0;
      }
      html
        body[for="html-export"]:not(
          [data-presentation-mode]
        )[html-show-sidebar-toc]
        .md-sidebar-toc
        .md-toc
        .md-toc-link-wrapper
        .md-toc-link
        div,
      html
        body[for="html-export"]:not(
          [data-presentation-mode]
        )[html-show-sidebar-toc]
        .md-sidebar-toc
        .md-toc
        .md-toc-link-wrapper
        .md-toc-link
        p {
        display: inline;
      }
      html
        body[for="html-export"]:not(
          [data-presentation-mode]
        )[html-show-sidebar-toc]
        .md-sidebar-toc
        .md-toc
        .md-toc-link-wrapper.highlighted
        .md-toc-link {
        font-weight: 800;
      }
      html
        body[for="html-export"]:not(
          [data-presentation-mode]
        )[html-show-sidebar-toc]
        .markdown-preview {
        left: 300px;
        width: calc(100% - 300px);
        padding: 2em calc(50% - 457px - 300px / 2);
        margin: 0;
        box-sizing: border-box;
      }
      @media screen and (max-width: 1274px) {
        html
          body[for="html-export"]:not(
            [data-presentation-mode]
          )[html-show-sidebar-toc]
          .markdown-preview {
          padding: 2em;
        }
      }
      @media screen and (max-width: 450px) {
        html
          body[for="html-export"]:not(
            [data-presentation-mode]
          )[html-show-sidebar-toc]
          .markdown-preview {
          width: 100%;
        }
      }
      html
        body[for="html-export"]:not([data-presentation-mode]):not(
          [html-show-sidebar-toc]
        )
        .markdown-preview {
        left: 50%;
        transform: translateX(-50%);
      }
      html
        body[for="html-export"]:not([data-presentation-mode]):not(
          [html-show-sidebar-toc]
        )
        .md-sidebar-toc {
        display: none;
      }
      /* Please visit the URL below for more information: */
      /*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */
      .markdown-preview.markdown-preview html body {
        background-image: url("https://images.pexels.com/photos/29386479/pexels-photo-29386479.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2");
        background-size: cover;
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-position: center;
        position: relative;
      }
      .markdown-preview.markdown-preview html body::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: inherit;
        background-size: cover;
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-position: center;
        filter: blur(1px);
        /* 设置模糊效果 */
        z-index: -2;
      }
      .markdown-preview.markdown-preview html body::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.6);
        /* 白色蒙版 */
        z-index: -1;
      }
    </style>
    <!-- The content below will be included at the end of the <head> element. -->
    <script type="text/javascript">
      document.addEventListener("DOMContentLoaded", function () {
        // your code here
      });
    </script>
  </head>
  <body for="html-export">
    <div class="crossnote markdown-preview">
      <h1
        id="faster-r-cnn-towards-real-time-object-detection-with-region-proposal-networks阅读笔记"
      >
        《Faster R-CNN: Towards Real-Time Object Detection with Region Proposal
        Networks》阅读笔记
      </h1>
      <h2 id="简介">简介</h2>
      <p>
        Fast R-CNN 等模型优化了监测网络，但在 Selective Search 选定 region
        proposal 的时候效率太低，于是 Faster R-CNN 提出 RPN
        直接卷积特征图预设锚框，把预设部分合并原来的 Fast R-CNN
        的检测部分放在一起训练，极大提升了效率与精度。
      </p>
      <blockquote>
        <p>端到端训练：整个系统从输入到输出所有步骤都是可训练且联合优化的。</p>
      </blockquote>
      <h2 id="背景">背景</h2>
      <p>
        目前获取 region proposal 的最流行的方法是 selective
        search，它的核心是贪心算法。
      </p>
      <blockquote>
        <p>
          先用图像分割算法把图片分割为一些小超像素（即一些颜色和纹理等底层特征相似的部分）。对于所有相邻的超像素对，找出相似度最高的两个区域（<em>贪心</em>）合并为新区域，移除这两个区域的所有相关项，把新区域和相邻区域纳入运算，一直循环。
        </p>
      </blockquote>
      <p>
        这种运算明显是在 CPU 上跑的，算法本身和不能多线程运算都决定了它慢（CPU
        上
        2s/图），拖累了整个模型的速度；而且贪心容易陷入局部最优，也处理不了复杂的图像。<br />
        新方法 edgeboxes 稍微好一点，但是因为在 CPU
        上跑，并且不能结合语义，所以精度效率都不好。<br />
        如果实现为在 GPU 上面跑呢？但是不把它和后面的 detection network
        架设到一起共享权重，好像浪费了；并且发现 CNN 提取的特征还可以帮助生成
        region proposal ，所以 RPN 就这样干了。
      </p>
      <p>目标检测时多尺度处理是一个重要的部分。常见的三种处理关系：</p>
      <ol>
        <li>
          图像金字塔和特征金字塔<br />
          缩放出来多个尺度的图像，分别提取特征，单独检测（非常慢）
        </li>
        <li>
          滤波器金字塔<br />
          使用多个不同尺寸或者比例的 filter
          来检测不同尺度物体（因为需要事先设定多个滤波器，参数冗余，灵活性差）
        </li>
        <li>
          <span style="color: #ff0000">参考框（锚框）金字塔</span><br />
          事先对单尺度图上提取到的特征设定多个 archor（archor
          的超参数需要事先定义），对每个 archor
          预测分类得分和回归偏移量。灵活且高效率。
        </li>
      </ol>
      <p>Faster R-CNN 采用第三种。</p>
      <h2 id="实现">实现</h2>
      <p>
        Faster R-CNN 由两个部分组成。一个是 Fast R-CNN 的预测模块，一个是
        RPN。RPN
        就好像“注意力机制”一样提醒预测模块要注意什么，预测出来的结果反向传播时又能够同时训练预测模块和
        RPN 的性能。
      </p>
      <h3 id="rpn">RPN</h3>
      <p>
        用于特征提取的卷积层是被共享的，然后再分支。<br />
        生成候选区域时，用一个
        <span class="katex"
          ><span class="katex-mathml"
            ><math xmlns="http://www.w3.org/1998/Math/MathML"
              ><semantics
                ><mrow><mi>n</mi><mo>×</mo><mi>n</mi></mrow
                ><annotation encoding="application/x-tex"
                  >n \times n</annotation
                ></semantics
              ></math
            ></span
          ><span class="katex-html" aria-hidden="true"
            ><span class="base"
              ><span
                class="strut"
                style="height: 0.6667em; vertical-align: -0.0833em"
              ></span
              ><span class="mord mathnormal">n</span
              ><span class="mspace" style="margin-right: 0.2222em"></span
              ><span class="mbin">×</span
              ><span class="mspace" style="margin-right: 0.2222em"></span></span
            ><span class="base"
              ><span class="strut" style="height: 0.4306em"></span
              ><span class="mord mathnormal">n</span></span
            ></span
          ></span
        >（通常取<span class="katex"
          ><span class="katex-mathml"
            ><math xmlns="http://www.w3.org/1998/Math/MathML"
              ><semantics
                ><mrow><mi>n</mi><mo>=</mo><mn>3</mn></mrow
                ><annotation encoding="application/x-tex"
                  >n=3</annotation
                ></semantics
              ></math
            ></span
          ><span class="katex-html" aria-hidden="true"
            ><span class="base"
              ><span class="strut" style="height: 0.4306em"></span
              ><span class="mord mathnormal">n</span
              ><span class="mspace" style="margin-right: 0.2778em"></span
              ><span class="mrel">=</span
              ><span class="mspace" style="margin-right: 0.2778em"></span></span
            ><span class="base"
              ><span class="strut" style="height: 0.6444em"></span
              ><span class="mord">3</span></span
            ></span
          ></span
        >）卷积层去对特征图卷积，然后再用两个<span class="katex"
          ><span class="katex-mathml"
            ><math xmlns="http://www.w3.org/1998/Math/MathML"
              ><semantics
                ><mrow><mn>1</mn><mo>×</mo><mn>1</mn></mrow
                ><annotation encoding="application/x-tex"
                  >1 \times 1</annotation
                ></semantics
              ></math
            ></span
          ><span class="katex-html" aria-hidden="true"
            ><span class="base"
              ><span
                class="strut"
                style="height: 0.7278em; vertical-align: -0.0833em"
              ></span
              ><span class="mord">1</span
              ><span class="mspace" style="margin-right: 0.2222em"></span
              ><span class="mbin">×</span
              ><span class="mspace" style="margin-right: 0.2222em"></span></span
            ><span class="base"
              ><span class="strut" style="height: 0.6444em"></span
              ><span class="mord">1</span></span
            ></span
          ></span
        >
        卷积层分离特征，流入回归分支和分类分支。
      </p>
      <p>
        <img
          src="https://github.com/mingqian-233/CV-Notes/blob/master/images/faster_rcnn.png?raw=true"
          alt="Fast R-CNN"
        />
      </p>
      <h4 id="锚框">锚框</h4>
      <p>
        <span class="katex"
          ><span class="katex-mathml"
            ><math xmlns="http://www.w3.org/1998/Math/MathML"
              ><semantics
                ><mrow><mn>3</mn><mo>×</mo><mn>3</mn></mrow
                ><annotation encoding="application/x-tex"
                  >3 \times 3</annotation
                ></semantics
              ></math
            ></span
          ><span class="katex-html" aria-hidden="true"
            ><span class="base"
              ><span
                class="strut"
                style="height: 0.7278em; vertical-align: -0.0833em"
              ></span
              ><span class="mord">3</span
              ><span class="mspace" style="margin-right: 0.2222em"></span
              ><span class="mbin">×</span
              ><span class="mspace" style="margin-right: 0.2222em"></span></span
            ><span class="base"
              ><span class="strut" style="height: 0.6444em"></span
              ><span class="mord">3</span></span
            ></span
          ></span
        >
        层滑动的时候，会以滑动窗口为中心，生成若干个锚框（这些锚框可以被映射回原图，它们大致捕获了图像的特征）。锚框的个数如下：<br />
        <span class="katex-display"
          ><span class="katex"
            ><span class="katex-mathml"
              ><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"
                ><semantics
                  ><mrow
                    ><mtext>单点锚框个数</mtext><mo>=</mo><mtext>尺度个数</mtext
                    ><mo>×</mo><mtext>缩放比个数</mtext
                    ><mspace linebreak="newline"></mspace
                    ><mtext>总锚框个数</mtext><mo>=</mo
                    ><mtext>单点锚框个数</mtext><mo>×</mo
                    ><mtext>特征图大小</mtext></mrow
                  ><annotation encoding="application/x-tex"
                    >\text{单点锚框个数} = \text{尺度个数} \times
                    \text{缩放比个数} \\ \text{总锚框个数} = \text{单点锚框个数}
                    \times \text{特征图大小}</annotation
                  ></semantics
                ></math
              ></span
            ><span class="katex-html" aria-hidden="true"
              ><span class="base"
                ><span class="strut" style="height: 0.6833em"></span
                ><span class="mord text"
                  ><span class="mord cjk_fallback">单点锚框个数</span></span
                ><span class="mspace" style="margin-right: 0.2778em"></span
                ><span class="mrel">=</span
                ><span
                  class="mspace"
                  style="margin-right: 0.2778em"
                ></span></span
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 0.7667em; vertical-align: -0.0833em"
                ></span
                ><span class="mord text"
                  ><span class="mord cjk_fallback">尺度个数</span></span
                ><span class="mspace" style="margin-right: 0.2222em"></span
                ><span class="mbin">×</span
                ><span
                  class="mspace"
                  style="margin-right: 0.2222em"
                ></span></span
              ><span class="base"
                ><span class="strut" style="height: 0.6833em"></span
                ><span class="mord text"
                  ><span class="mord cjk_fallback">缩放比个数</span></span
                ></span
              ><span class="mspace newline"></span
              ><span class="base"
                ><span class="strut" style="height: 0.6833em"></span
                ><span class="mord text"
                  ><span class="mord cjk_fallback">总锚框个数</span></span
                ><span class="mspace" style="margin-right: 0.2778em"></span
                ><span class="mrel">=</span
                ><span
                  class="mspace"
                  style="margin-right: 0.2778em"
                ></span></span
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 0.7667em; vertical-align: -0.0833em"
                ></span
                ><span class="mord text"
                  ><span class="mord cjk_fallback">单点锚框个数</span></span
                ><span class="mspace" style="margin-right: 0.2222em"></span
                ><span class="mbin">×</span
                ><span
                  class="mspace"
                  style="margin-right: 0.2222em"
                ></span></span
              ><span class="base"
                ><span class="strut" style="height: 0.6833em"></span
                ><span class="mord text"
                  ><span class="mord cjk_fallback">特征图大小</span></span
                ></span
              ></span
            ></span
          ></span
        >
      </p>
      <blockquote>
        <ol>
          <li>该方法下的锚框具有平移不变性；</li>
          <li>
            这种“锚框金字塔”稳定获取多尺度的同时可以节省效率，也有利于共享特征。
          </li>
        </ol>
      </blockquote>
      <h4 id="rpn-的损失函数">RPN 的损失函数</h4>
      <p>
        训练 RPN 时，每个锚点会被分配 Positive/Negative label，遵循规则如下：
      </p>
      <ol>
        <li>
          与其对应的真实框和它的 IoU 中，是真实框所有匹配到的锚框的 IoU
          中最大的；<strong>或者</strong>和对应的真实框的 IoU
          <span class="katex"
            ><span class="katex-mathml"
              ><math xmlns="http://www.w3.org/1998/Math/MathML"
                ><semantics
                  ><mrow><mo>≥</mo></mrow
                  ><annotation encoding="application/x-tex"
                    >\geq</annotation
                  ></semantics
                ></math
              ></span
            ><span class="katex-html" aria-hidden="true"
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 0.7719em; vertical-align: -0.136em"
                ></span
                ><span class="mrel">≥</span></span
              ></span
            ></span
          >
          0.7，则为正标签；
        </li>
        <li>IoU &lt; 0.3，则为负标签；</li>
        <li>不符合上述两点的，直接忽视掉。</li>
      </ol>
      <blockquote>
        <p>
          显然这个分配方法在计算 IoU 的时候对应的复杂度为平方级别的<span
            class="katex"
            ><span class="katex-mathml"
              ><math xmlns="http://www.w3.org/1998/Math/MathML"
                ><semantics
                  ><mrow
                    ><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mi>M</mi
                    ><mo stretchy="false">)</mo></mrow
                  ><annotation encoding="application/x-tex"
                    >O(NM)</annotation
                  ></semantics
                ></math
              ></span
            ><span class="katex-html" aria-hidden="true"
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 1em; vertical-align: -0.25em"
                ></span
                ><span class="mord mathnormal" style="margin-right: 0.02778em"
                  >O</span
                ><span class="mopen">(</span
                ><span class="mord mathnormal" style="margin-right: 0.10903em"
                  >NM</span
                ><span class="mclose">)</span></span
              ></span
            ></span
          >，其中<span class="katex"
            ><span class="katex-mathml"
              ><math xmlns="http://www.w3.org/1998/Math/MathML"
                ><semantics
                  ><mrow><mi>N</mi></mrow
                  ><annotation encoding="application/x-tex"
                    >N</annotation
                  ></semantics
                ></math
              ></span
            ><span class="katex-html" aria-hidden="true"
              ><span class="base"
                ><span class="strut" style="height: 0.6833em"></span
                ><span class="mord mathnormal" style="margin-right: 0.10903em"
                  >N</span
                ></span
              ></span
            ></span
          >为真实框个数，<span class="katex"
            ><span class="katex-mathml"
              ><math xmlns="http://www.w3.org/1998/Math/MathML"
                ><semantics
                  ><mrow><mi>M</mi></mrow
                  ><annotation encoding="application/x-tex"
                    >M</annotation
                  ></semantics
                ></math
              ></span
            ><span class="katex-html" aria-hidden="true"
              ><span class="base"
                ><span class="strut" style="height: 0.6833em"></span
                ><span class="mord mathnormal" style="margin-right: 0.10903em"
                  >M</span
                ></span
              ></span
            ></span
          >为锚框个数。但其实一般来说 N 都很小，运算次数并不会很多。
        </p>
      </blockquote>
      <p>
        训练 RPN 时，对于一整个
        mini_batch，损失函数的计算公式很好理解，就是把分类的损失和<span
          style="color: #ff0000; font-weight: bold"
          >正样本</span
        >的位置回归的损失带权加在一起。<br />
        公式为：
      </p>
      <p>
        <span class="katex-display"
          ><span class="katex"
            ><span class="katex-mathml"
              ><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"
                ><semantics
                  ><mrow
                    ><mi>L</mi><mo stretchy="false">(</mo
                    ><mo stretchy="false">{</mo><msub><mi>p</mi><mi>i</mi></msub
                    ><mo stretchy="false">}</mo><mo separator="true">,</mo
                    ><mo stretchy="false">{</mo><msub><mi>t</mi><mi>i</mi></msub
                    ><mo stretchy="false">}</mo><mo stretchy="false">)</mo
                    ><mo>=</mo
                    ><mfrac
                      ><mn>1</mn
                      ><msub><mi>N</mi><mtext>cls</mtext></msub></mfrac
                    ><munder><mo>∑</mo><mi>i</mi></munder
                    ><msub><mi>L</mi><mtext>cls</mtext></msub
                    ><mo stretchy="false">(</mo><msub><mi>p</mi><mi>i</mi></msub
                    ><mo separator="true">,</mo
                    ><msubsup><mi>p</mi><mi>i</mi><mo>∗</mo></msubsup
                    ><mo stretchy="false">)</mo><mo>+</mo><mi>λ</mi
                    ><mfrac
                      ><mn>1</mn
                      ><msub><mi>N</mi><mtext>reg</mtext></msub></mfrac
                    ><munder><mo>∑</mo><mi>i</mi></munder
                    ><msubsup><mi>p</mi><mi>i</mi><mo>∗</mo></msubsup
                    ><msub><mi>L</mi><mtext>reg</mtext></msub
                    ><mo stretchy="false">(</mo><msub><mi>t</mi><mi>i</mi></msub
                    ><mo separator="true">,</mo
                    ><msubsup><mi>t</mi><mi>i</mi><mo>∗</mo></msubsup
                    ><mo stretchy="false">)</mo></mrow
                  ><annotation encoding="application/x-tex"
                    >L(\{p_i\}, \{t_i\}) = \frac{1}{N_{\text{cls}}} \sum_i
                    L_{\text{cls}}(p_i, p_i^*) + \lambda
                    \frac{1}{N_{\text{reg}}} \sum_i p_i^* L_{\text{reg}}(t_i,
                    t_i^*)</annotation
                  ></semantics
                ></math
              ></span
            ><span class="katex-html" aria-hidden="true"
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 1em; vertical-align: -0.25em"
                ></span
                ><span class="mord mathnormal">L</span
                ><span class="mopen">({</span
                ><span class="mord"
                  ><span class="mord mathnormal">p</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.3117em"
                          ><span
                            style="
                              top: -2.55em;
                              margin-left: 0em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mord mathnormal mtight"
                                >i</span
                              ></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.15em"
                          ><span></span></span></span></span></span></span
                ><span class="mclose">}</span><span class="mpunct">,</span
                ><span class="mspace" style="margin-right: 0.1667em"></span
                ><span class="mopen">{</span
                ><span class="mord"
                  ><span class="mord mathnormal">t</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.3117em"
                          ><span
                            style="
                              top: -2.55em;
                              margin-left: 0em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mord mathnormal mtight"
                                >i</span
                              ></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.15em"
                          ><span></span></span></span></span></span></span
                ><span class="mclose">})</span
                ><span class="mspace" style="margin-right: 0.2778em"></span
                ><span class="mrel">=</span
                ><span
                  class="mspace"
                  style="margin-right: 0.2778em"
                ></span></span
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 2.5991em; vertical-align: -1.2777em"
                ></span
                ><span class="mord"
                  ><span class="mopen nulldelimiter"></span
                  ><span class="mfrac"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 1.3214em"
                          ><span style="top: -2.314em"
                            ><span class="pstrut" style="height: 3em"></span
                            ><span class="mord"
                              ><span class="mord"
                                ><span
                                  class="mord mathnormal"
                                  style="margin-right: 0.10903em"
                                  >N</span
                                ><span class="msupsub"
                                  ><span class="vlist-t vlist-t2"
                                    ><span class="vlist-r"
                                      ><span
                                        class="vlist"
                                        style="height: 0.3361em"
                                        ><span
                                          style="
                                            top: -2.55em;
                                            margin-left: -0.109em;
                                            margin-right: 0.05em;
                                          "
                                          ><span
                                            class="pstrut"
                                            style="height: 2.7em"
                                          ></span
                                          ><span
                                            class="sizing reset-size6 size3 mtight"
                                            ><span class="mord mtight"
                                              ><span class="mord text mtight"
                                                ><span class="mord mtight"
                                                  >cls</span
                                                ></span
                                              ></span
                                            ></span
                                          ></span
                                        ></span
                                      ><span class="vlist-s">​</span></span
                                    ><span class="vlist-r"
                                      ><span
                                        class="vlist"
                                        style="height: 0.15em"
                                        ><span></span></span></span></span></span></span></span></span
                          ><span style="top: -3.23em"
                            ><span class="pstrut" style="height: 3em"></span
                            ><span
                              class="frac-line"
                              style="border-bottom-width: 0.04em"
                            ></span></span
                          ><span style="top: -3.677em"
                            ><span class="pstrut" style="height: 3em"></span
                            ><span class="mord"
                              ><span class="mord">1</span></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.836em"
                          ><span></span></span></span></span></span
                  ><span class="mclose nulldelimiter"></span></span
                ><span class="mspace" style="margin-right: 0.1667em"></span
                ><span class="mop op-limits"
                  ><span class="vlist-t vlist-t2"
                    ><span class="vlist-r"
                      ><span class="vlist" style="height: 1.05em"
                        ><span style="top: -1.8723em; margin-left: 0em"
                          ><span class="pstrut" style="height: 3.05em"></span
                          ><span class="sizing reset-size6 size3 mtight"
                            ><span class="mord mathnormal mtight">i</span></span
                          ></span
                        ><span style="top: -3.05em"
                          ><span class="pstrut" style="height: 3.05em"></span
                          ><span
                            ><span class="mop op-symbol large-op">∑</span></span
                          ></span
                        ></span
                      ><span class="vlist-s">​</span></span
                    ><span class="vlist-r"
                      ><span class="vlist" style="height: 1.2777em"
                        ><span></span></span></span></span></span
                ><span class="mspace" style="margin-right: 0.1667em"></span
                ><span class="mord"
                  ><span class="mord mathnormal">L</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.3361em"
                          ><span
                            style="
                              top: -2.55em;
                              margin-left: 0em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mord mtight"
                                ><span class="mord text mtight"
                                  ><span class="mord mtight">cls</span></span
                                ></span
                              ></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.15em"
                          ><span></span></span></span></span></span></span
                ><span class="mopen">(</span
                ><span class="mord"
                  ><span class="mord mathnormal">p</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.3117em"
                          ><span
                            style="
                              top: -2.55em;
                              margin-left: 0em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mord mathnormal mtight"
                                >i</span
                              ></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.15em"
                          ><span></span></span></span></span></span></span
                ><span class="mpunct">,</span
                ><span class="mspace" style="margin-right: 0.1667em"></span
                ><span class="mord"
                  ><span class="mord mathnormal">p</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.7387em"
                          ><span
                            style="
                              top: -2.453em;
                              margin-left: 0em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mord mathnormal mtight"
                                >i</span
                              ></span
                            ></span
                          ><span style="top: -3.113em; margin-right: 0.05em"
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mbin mtight">∗</span></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.247em"
                          ><span></span></span></span></span></span></span
                ><span class="mclose">)</span
                ><span class="mspace" style="margin-right: 0.2222em"></span
                ><span class="mbin">+</span
                ><span
                  class="mspace"
                  style="margin-right: 0.2222em"
                ></span></span
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 2.5991em; vertical-align: -1.2777em"
                ></span
                ><span class="mord mathnormal">λ</span
                ><span class="mord"
                  ><span class="mopen nulldelimiter"></span
                  ><span class="mfrac"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 1.3214em"
                          ><span style="top: -2.314em"
                            ><span class="pstrut" style="height: 3em"></span
                            ><span class="mord"
                              ><span class="mord"
                                ><span
                                  class="mord mathnormal"
                                  style="margin-right: 0.10903em"
                                  >N</span
                                ><span class="msupsub"
                                  ><span class="vlist-t vlist-t2"
                                    ><span class="vlist-r"
                                      ><span
                                        class="vlist"
                                        style="height: 0.1514em"
                                        ><span
                                          style="
                                            top: -2.55em;
                                            margin-left: -0.109em;
                                            margin-right: 0.05em;
                                          "
                                          ><span
                                            class="pstrut"
                                            style="height: 2.7em"
                                          ></span
                                          ><span
                                            class="sizing reset-size6 size3 mtight"
                                            ><span class="mord mtight"
                                              ><span class="mord text mtight"
                                                ><span class="mord mtight"
                                                  >reg</span
                                                ></span
                                              ></span
                                            ></span
                                          ></span
                                        ></span
                                      ><span class="vlist-s">​</span></span
                                    ><span class="vlist-r"
                                      ><span
                                        class="vlist"
                                        style="height: 0.2861em"
                                        ><span></span></span></span></span></span></span></span></span
                          ><span style="top: -3.23em"
                            ><span class="pstrut" style="height: 3em"></span
                            ><span
                              class="frac-line"
                              style="border-bottom-width: 0.04em"
                            ></span></span
                          ><span style="top: -3.677em"
                            ><span class="pstrut" style="height: 3em"></span
                            ><span class="mord"
                              ><span class="mord">1</span></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.9721em"
                          ><span></span></span></span></span></span
                  ><span class="mclose nulldelimiter"></span></span
                ><span class="mspace" style="margin-right: 0.1667em"></span
                ><span class="mop op-limits"
                  ><span class="vlist-t vlist-t2"
                    ><span class="vlist-r"
                      ><span class="vlist" style="height: 1.05em"
                        ><span style="top: -1.8723em; margin-left: 0em"
                          ><span class="pstrut" style="height: 3.05em"></span
                          ><span class="sizing reset-size6 size3 mtight"
                            ><span class="mord mathnormal mtight">i</span></span
                          ></span
                        ><span style="top: -3.05em"
                          ><span class="pstrut" style="height: 3.05em"></span
                          ><span
                            ><span class="mop op-symbol large-op">∑</span></span
                          ></span
                        ></span
                      ><span class="vlist-s">​</span></span
                    ><span class="vlist-r"
                      ><span class="vlist" style="height: 1.2777em"
                        ><span></span></span></span></span></span
                ><span class="mspace" style="margin-right: 0.1667em"></span
                ><span class="mord"
                  ><span class="mord mathnormal">p</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.7387em"
                          ><span
                            style="
                              top: -2.453em;
                              margin-left: 0em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mord mathnormal mtight"
                                >i</span
                              ></span
                            ></span
                          ><span style="top: -3.113em; margin-right: 0.05em"
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mbin mtight">∗</span></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.247em"
                          ><span></span></span></span></span></span></span
                ><span class="mord"
                  ><span class="mord mathnormal">L</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.1514em"
                          ><span
                            style="
                              top: -2.55em;
                              margin-left: 0em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mord mtight"
                                ><span class="mord text mtight"
                                  ><span class="mord mtight">reg</span></span
                                ></span
                              ></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.2861em"
                          ><span></span></span></span></span></span></span
                ><span class="mopen">(</span
                ><span class="mord"
                  ><span class="mord mathnormal">t</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.3117em"
                          ><span
                            style="
                              top: -2.55em;
                              margin-left: 0em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mord mathnormal mtight"
                                >i</span
                              ></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.15em"
                          ><span></span></span></span></span></span></span
                ><span class="mpunct">,</span
                ><span class="mspace" style="margin-right: 0.1667em"></span
                ><span class="mord"
                  ><span class="mord mathnormal">t</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.7387em"
                          ><span
                            style="
                              top: -2.453em;
                              margin-left: 0em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mord mathnormal mtight"
                                >i</span
                              ></span
                            ></span
                          ><span style="top: -3.113em; margin-right: 0.05em"
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mbin mtight">∗</span></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.247em"
                          ><span></span></span></span></span></span></span
                ><span class="mclose">)</span></span
              ></span
            ></span
          ></span
        >
      </p>
      <p>
        <span class="katex-display"
          ><span class="katex"
            ><span class="katex-mathml"
              ><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"
                ><semantics
                  ><mrow
                    ><msub><mi>p</mi><mi>i</mi></msub
                    ><mtext
                      >：预测模型的结果，二分类概率，表示框里面有一个需要检测的目标的置信度</mtext
                    ><mspace linebreak="newline"></mspace
                    ><msubsup><mi>p</mi><mi>i</mi><mo>∗</mo></msubsup
                    ><mtext>：</mtext><mn>0</mn><mtext>表示锚框是负样本，</mtext
                    ><mn>1</mn><mtext>表示锚框是正样本</mtext
                    ><mspace linebreak="newline"></mspace
                    ><msub><mi>t</mi><mi>i</mi></msub
                    ><mo separator="true">,</mo
                    ><msubsup><mi>t</mi><mi>i</mi><mo>∗</mo></msubsup
                    ><mtext>：分别是锚框和真实框的位置表示</mtext
                    ><mspace linebreak="newline"></mspace
                    ><msub
                      ><mi>N</mi
                      ><mrow><mi>c</mi><mi>l</mi><mi>s</mi></mrow></msub
                    ><mtext>：归一化项，和mini-batch中的锚框数量相等</mtext
                    ><mspace linebreak="newline"></mspace
                    ><msub
                      ><mi>N</mi
                      ><mrow><mi>r</mi><mi>e</mi><mi>g</mi></mrow></msub
                    ><mtext>：特征图尺寸（锚框位置数）</mtext
                    ><mspace linebreak="newline"></mspace><mi>λ</mi
                    ><mtext>：超参数，并不敏感，论文中设为</mtext><mn>10</mn
                    ><mspace linebreak="newline"></mspace
                    ><msub
                      ><mi>L</mi
                      ><mrow><mi>c</mi><mi>l</mi><mi>s</mi></mrow></msub
                    ><mtext>：对数损失</mtext
                    ><mspace linebreak="newline"></mspace
                    ><msub
                      ><mi>L</mi
                      ><mrow><mi>r</mi><mi>e</mi><mi>g</mi></mrow></msub
                    ><mtext>：</mtext><mi>s</mi><mi>m</mi><mi>o</mi><mi>o</mi
                    ><mi>t</mi><mi>h</mi><mtext>&nbsp;</mtext
                    ><msub><mi>L</mi><mn>1</mn></msub
                    ><mtext>损失</mtext></mrow
                  ><annotation encoding="application/x-tex"
                    >p_i：预测模型的结果，二分类概率，表示框里面有一个需要检测的目标的置信度\\
                    p_i^*：0 表示锚框是负样本，1 表示锚框是正样本\\
                    t_i,t_i^*：分别是锚框和真实框的位置表示\\
                    N_{cls}：归一化项，和\text{mini-batch}中的锚框数量相等\\
                    N_{reg}：特征图尺寸（锚框位置数）\\
                    \lambda：超参数，并不敏感，论文中设为10\\
                    L_{cls}：对数损失\\
                    L_{reg}：smooth{\space}L_1损失</annotation
                  ></semantics
                ></math
              ></span
            ><span class="katex-html" aria-hidden="true"
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 0.8778em; vertical-align: -0.1944em"
                ></span
                ><span class="mord"
                  ><span class="mord mathnormal">p</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.3117em"
                          ><span
                            style="
                              top: -2.55em;
                              margin-left: 0em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mord mathnormal mtight"
                                >i</span
                              ></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.15em"
                          ><span></span></span></span></span></span></span
                ><span class="mord cjk_fallback"
                  >：预测模型的结果，二分类概率，表示框里面有一个需要检测的目标的置信度</span
                ></span
              ><span class="mspace newline"></span
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 0.9857em; vertical-align: -0.247em"
                ></span
                ><span class="mord"
                  ><span class="mord mathnormal">p</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.7387em"
                          ><span
                            style="
                              top: -2.453em;
                              margin-left: 0em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mord mathnormal mtight"
                                >i</span
                              ></span
                            ></span
                          ><span style="top: -3.113em; margin-right: 0.05em"
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mbin mtight">∗</span></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.247em"
                          ><span></span></span></span></span></span></span
                ><span class="mord cjk_fallback">：</span
                ><span class="mord">0</span
                ><span class="mord cjk_fallback">表示锚框是负样本，</span
                ><span class="mord">1</span
                ><span class="mord cjk_fallback">表示锚框是正样本</span></span
              ><span class="mspace newline"></span
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 0.9857em; vertical-align: -0.247em"
                ></span
                ><span class="mord"
                  ><span class="mord mathnormal">t</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.3117em"
                          ><span
                            style="
                              top: -2.55em;
                              margin-left: 0em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mord mathnormal mtight"
                                >i</span
                              ></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.15em"
                          ><span></span></span></span></span></span></span
                ><span class="mpunct">,</span
                ><span class="mspace" style="margin-right: 0.1667em"></span
                ><span class="mord"
                  ><span class="mord mathnormal">t</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.7387em"
                          ><span
                            style="
                              top: -2.453em;
                              margin-left: 0em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mord mathnormal mtight"
                                >i</span
                              ></span
                            ></span
                          ><span style="top: -3.113em; margin-right: 0.05em"
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mbin mtight">∗</span></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.247em"
                          ><span></span></span></span></span></span></span
                ><span class="mord cjk_fallback"
                  >：分别是锚框和真实框的位置表示</span
                ></span
              ><span class="mspace newline"></span
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 0.8444em; vertical-align: -0.15em"
                ></span
                ><span class="mord"
                  ><span class="mord mathnormal" style="margin-right: 0.10903em"
                    >N</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.3361em"
                          ><span
                            style="
                              top: -2.55em;
                              margin-left: -0.109em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mord mtight"
                                ><span class="mord mathnormal mtight">c</span
                                ><span
                                  class="mord mathnormal mtight"
                                  style="margin-right: 0.01968em"
                                  >l</span
                                ><span class="mord mathnormal mtight"
                                  >s</span
                                ></span
                              ></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.15em"
                          ><span></span></span></span></span></span></span
                ><span class="mord cjk_fallback">：归一化项，和</span
                ><span class="mord text"
                  ><span class="mord">mini-batch</span></span
                ><span class="mord cjk_fallback">中的锚框数量相等</span></span
              ><span class="mspace newline"></span
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 0.9694em; vertical-align: -0.2861em"
                ></span
                ><span class="mord"
                  ><span class="mord mathnormal" style="margin-right: 0.10903em"
                    >N</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.1514em"
                          ><span
                            style="
                              top: -2.55em;
                              margin-left: -0.109em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mord mtight"
                                ><span class="mord mathnormal mtight">re</span
                                ><span
                                  class="mord mathnormal mtight"
                                  style="margin-right: 0.03588em"
                                  >g</span
                                ></span
                              ></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.2861em"
                          ><span></span></span></span></span></span></span
                ><span class="mord cjk_fallback"
                  >：特征图尺寸（锚框位置数）</span
                ></span
              ><span class="mspace newline"></span
              ><span class="base"
                ><span class="strut" style="height: 0.6944em"></span
                ><span class="mord mathnormal">λ</span
                ><span class="mord cjk_fallback"
                  >：超参数，并不敏感，论文中设为</span
                ><span class="mord">10</span></span
              ><span class="mspace newline"></span
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 0.8333em; vertical-align: -0.15em"
                ></span
                ><span class="mord"
                  ><span class="mord mathnormal">L</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.3361em"
                          ><span
                            style="
                              top: -2.55em;
                              margin-left: 0em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mord mtight"
                                ><span class="mord mathnormal mtight">c</span
                                ><span
                                  class="mord mathnormal mtight"
                                  style="margin-right: 0.01968em"
                                  >l</span
                                ><span class="mord mathnormal mtight"
                                  >s</span
                                ></span
                              ></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.15em"
                          ><span></span></span></span></span></span></span
                ><span class="mord cjk_fallback">：对数损失</span></span
              ><span class="mspace newline"></span
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 0.9805em; vertical-align: -0.2861em"
                ></span
                ><span class="mord"
                  ><span class="mord mathnormal">L</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.1514em"
                          ><span
                            style="
                              top: -2.55em;
                              margin-left: 0em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mord mtight"
                                ><span class="mord mathnormal mtight">re</span
                                ><span
                                  class="mord mathnormal mtight"
                                  style="margin-right: 0.03588em"
                                  >g</span
                                ></span
                              ></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.2861em"
                          ><span></span></span></span></span></span></span
                ><span class="mord cjk_fallback">：</span
                ><span class="mord mathnormal">s</span
                ><span class="mord mathnormal">m</span
                ><span class="mord mathnormal">oo</span
                ><span class="mord mathnormal">t</span
                ><span class="mord mathnormal">h</span
                ><span class="mord"><span class="mspace">&nbsp;</span></span
                ><span class="mord"
                  ><span class="mord mathnormal">L</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.3011em"
                          ><span
                            style="
                              top: -2.55em;
                              margin-left: 0em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mord mtight">1</span></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.15em"
                          ><span></span></span></span></span></span></span
                ><span class="mord cjk_fallback">损失</span></span
              ></span
            ></span
          ></span
        >
      </p>
      <p>
        <span class="katex"
          ><span class="katex-mathml"
            ><math xmlns="http://www.w3.org/1998/Math/MathML"
              ><semantics
                ><mrow
                  ><mi>s</mi><mi>m</mi><mi>o</mi><mi>o</mi><mi>t</mi><mi>h</mi
                  ><mtext>&nbsp;</mtext><msub><mi>L</mi><mn>1</mn></msub></mrow
                ><annotation encoding="application/x-tex"
                  >{smooth \space L_1}</annotation
                ></semantics
              ></math
            ></span
          ><span class="katex-html" aria-hidden="true"
            ><span class="base"
              ><span
                class="strut"
                style="height: 0.8444em; vertical-align: -0.15em"
              ></span
              ><span class="mord"
                ><span class="mord mathnormal">s</span
                ><span class="mord mathnormal">m</span
                ><span class="mord mathnormal">oo</span
                ><span class="mord mathnormal">t</span
                ><span class="mord mathnormal">h</span
                ><span class="mspace">&nbsp;</span
                ><span class="mord"
                  ><span class="mord mathnormal">L</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.3011em"
                          ><span
                            style="
                              top: -2.55em;
                              margin-left: 0em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mord mtight">1</span></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.15em"
                          ><span></span></span></span></span></span></span></span></span></span></span
        >公式如下：
      </p>
      <p>
        <span class="katex-display"
          ><span class="katex"
            ><span class="katex-mathml"
              ><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"
                ><semantics
                  ><mrow
                    ><msub><mi>L</mi><mtext>reg</mtext></msub
                    ><mo>=</mo
                    ><mrow
                      ><mo fence="true">{</mo
                      ><mtable
                        rowspacing="0.36em"
                        columnalign="left left"
                        columnspacing="1em"
                        ><mtr
                          ><mtd
                            ><mstyle scriptlevel="0" displaystyle="false"
                              ><mrow
                                ><mn>0.5</mn><mo stretchy="false">(</mo
                                ><mi>t</mi><mo>−</mo
                                ><msup><mi>t</mi><mo>∗</mo></msup
                                ><msup
                                  ><mo stretchy="false">)</mo><mn>2</mn></msup
                                ><mi mathvariant="normal">/</mi><mi>β</mi
                                ><mo separator="true">,</mo></mrow
                              ></mstyle
                            ></mtd
                          ><mtd
                            ><mstyle scriptlevel="0" displaystyle="false"
                              ><mrow
                                ><mtext>if&nbsp;</mtext
                                ><mi mathvariant="normal">∣</mi><mi>t</mi
                                ><mo>−</mo><msup><mi>t</mi><mo>∗</mo></msup
                                ><mi mathvariant="normal">∣</mi><mo>&lt;</mo
                                ><mi>β</mi></mrow
                              ></mstyle
                            ></mtd
                          ></mtr
                        ><mtr
                          ><mtd
                            ><mstyle scriptlevel="0" displaystyle="false"
                              ><mrow
                                ><mi mathvariant="normal">∣</mi><mi>t</mi
                                ><mo>−</mo><msup><mi>t</mi><mo>∗</mo></msup
                                ><mi mathvariant="normal">∣</mi><mo>−</mo
                                ><mn>0.5</mn><mi>β</mi
                                ><mo separator="true">,</mo></mrow
                              ></mstyle
                            ></mtd
                          ><mtd
                            ><mstyle scriptlevel="0" displaystyle="false"
                              ><mtext>otherwise</mtext></mstyle
                            ></mtd
                          ></mtr
                        ></mtable
                      ></mrow
                    ></mrow
                  ><annotation encoding="application/x-tex"
                    >L_{\text{reg}} = \begin{cases} 0.5 (t - t^*)^2 / \beta,
                    &amp; \text{if } |t - t^*| &lt; \beta \\ |t - t^*| - 0.5
                    \beta, &amp; \text{otherwise} \end{cases}</annotation
                  ></semantics
                ></math
              ></span
            ><span class="katex-html" aria-hidden="true"
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 0.9694em; vertical-align: -0.2861em"
                ></span
                ><span class="mord"
                  ><span class="mord mathnormal">L</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.1514em"
                          ><span
                            style="
                              top: -2.55em;
                              margin-left: 0em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mord mtight"
                                ><span class="mord text mtight"
                                  ><span class="mord mtight">reg</span></span
                                ></span
                              ></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.2861em"
                          ><span></span></span></span></span></span></span
                ><span class="mspace" style="margin-right: 0.2778em"></span
                ><span class="mrel">=</span
                ><span
                  class="mspace"
                  style="margin-right: 0.2778em"
                ></span></span
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 3em; vertical-align: -1.25em"
                ></span
                ><span class="minner"
                  ><span class="mopen delimcenter" style="top: 0em"
                    ><span class="delimsizing size4">{</span></span
                  ><span class="mord"
                    ><span class="mtable"
                      ><span class="col-align-l"
                        ><span class="vlist-t vlist-t2"
                          ><span class="vlist-r"
                            ><span class="vlist" style="height: 1.69em"
                              ><span style="top: -3.69em"
                                ><span
                                  class="pstrut"
                                  style="height: 3.008em"
                                ></span
                                ><span class="mord"
                                  ><span class="mord">0.5</span
                                  ><span class="mopen">(</span
                                  ><span class="mord mathnormal">t</span
                                  ><span
                                    class="mspace"
                                    style="margin-right: 0.2222em"
                                  ></span
                                  ><span class="mbin">−</span
                                  ><span
                                    class="mspace"
                                    style="margin-right: 0.2222em"
                                  ></span
                                  ><span class="mord"
                                    ><span class="mord mathnormal">t</span
                                    ><span class="msupsub"
                                      ><span class="vlist-t"
                                        ><span class="vlist-r"
                                          ><span
                                            class="vlist"
                                            style="height: 0.6887em"
                                            ><span
                                              style="
                                                top: -3.063em;
                                                margin-right: 0.05em;
                                              "
                                              ><span
                                                class="pstrut"
                                                style="height: 2.7em"
                                              ></span
                                              ><span
                                                class="sizing reset-size6 size3 mtight"
                                                ><span class="mbin mtight"
                                                  >∗</span
                                                ></span
                                              ></span
                                            ></span
                                          ></span
                                        ></span
                                      ></span
                                    ></span
                                  ><span class="mclose"
                                    ><span class="mclose">)</span
                                    ><span class="msupsub"
                                      ><span class="vlist-t"
                                        ><span class="vlist-r"
                                          ><span
                                            class="vlist"
                                            style="height: 0.8141em"
                                            ><span
                                              style="
                                                top: -3.063em;
                                                margin-right: 0.05em;
                                              "
                                              ><span
                                                class="pstrut"
                                                style="height: 2.7em"
                                              ></span
                                              ><span
                                                class="sizing reset-size6 size3 mtight"
                                                ><span class="mord mtight"
                                                  >2</span
                                                ></span
                                              ></span
                                            ></span
                                          ></span
                                        ></span
                                      ></span
                                    ></span
                                  ><span class="mord">/</span
                                  ><span
                                    class="mord mathnormal"
                                    style="margin-right: 0.05278em"
                                    >β</span
                                  ><span class="mpunct">,</span></span
                                ></span
                              ><span style="top: -2.25em"
                                ><span
                                  class="pstrut"
                                  style="height: 3.008em"
                                ></span
                                ><span class="mord"
                                  ><span class="mord">∣</span
                                  ><span class="mord mathnormal">t</span
                                  ><span
                                    class="mspace"
                                    style="margin-right: 0.2222em"
                                  ></span
                                  ><span class="mbin">−</span
                                  ><span
                                    class="mspace"
                                    style="margin-right: 0.2222em"
                                  ></span
                                  ><span class="mord"
                                    ><span class="mord mathnormal">t</span
                                    ><span class="msupsub"
                                      ><span class="vlist-t"
                                        ><span class="vlist-r"
                                          ><span
                                            class="vlist"
                                            style="height: 0.6887em"
                                            ><span
                                              style="
                                                top: -3.063em;
                                                margin-right: 0.05em;
                                              "
                                              ><span
                                                class="pstrut"
                                                style="height: 2.7em"
                                              ></span
                                              ><span
                                                class="sizing reset-size6 size3 mtight"
                                                ><span class="mbin mtight"
                                                  >∗</span
                                                ></span
                                              ></span
                                            ></span
                                          ></span
                                        ></span
                                      ></span
                                    ></span
                                  ><span class="mord">∣</span
                                  ><span
                                    class="mspace"
                                    style="margin-right: 0.2222em"
                                  ></span
                                  ><span class="mbin">−</span
                                  ><span
                                    class="mspace"
                                    style="margin-right: 0.2222em"
                                  ></span
                                  ><span class="mord">0.5</span
                                  ><span
                                    class="mord mathnormal"
                                    style="margin-right: 0.05278em"
                                    >β</span
                                  ><span class="mpunct">,</span></span
                                ></span
                              ></span
                            ><span class="vlist-s">​</span></span
                          ><span class="vlist-r"
                            ><span class="vlist" style="height: 1.19em"
                              ><span></span></span></span></span></span
                      ><span class="arraycolsep" style="width: 1em"></span
                      ><span class="col-align-l"
                        ><span class="vlist-t vlist-t2"
                          ><span class="vlist-r"
                            ><span class="vlist" style="height: 1.69em"
                              ><span style="top: -3.69em"
                                ><span
                                  class="pstrut"
                                  style="height: 3.008em"
                                ></span
                                ><span class="mord"
                                  ><span class="mord text"
                                    ><span class="mord">if&nbsp;</span></span
                                  ><span class="mord">∣</span
                                  ><span class="mord mathnormal">t</span
                                  ><span
                                    class="mspace"
                                    style="margin-right: 0.2222em"
                                  ></span
                                  ><span class="mbin">−</span
                                  ><span
                                    class="mspace"
                                    style="margin-right: 0.2222em"
                                  ></span
                                  ><span class="mord"
                                    ><span class="mord mathnormal">t</span
                                    ><span class="msupsub"
                                      ><span class="vlist-t"
                                        ><span class="vlist-r"
                                          ><span
                                            class="vlist"
                                            style="height: 0.6887em"
                                            ><span
                                              style="
                                                top: -3.063em;
                                                margin-right: 0.05em;
                                              "
                                              ><span
                                                class="pstrut"
                                                style="height: 2.7em"
                                              ></span
                                              ><span
                                                class="sizing reset-size6 size3 mtight"
                                                ><span class="mbin mtight"
                                                  >∗</span
                                                ></span
                                              ></span
                                            ></span
                                          ></span
                                        ></span
                                      ></span
                                    ></span
                                  ><span class="mord">∣</span
                                  ><span
                                    class="mspace"
                                    style="margin-right: 0.2778em"
                                  ></span
                                  ><span class="mrel">&lt;</span
                                  ><span
                                    class="mspace"
                                    style="margin-right: 0.2778em"
                                  ></span
                                  ><span
                                    class="mord mathnormal"
                                    style="margin-right: 0.05278em"
                                    >β</span
                                  ></span
                                ></span
                              ><span style="top: -2.25em"
                                ><span
                                  class="pstrut"
                                  style="height: 3.008em"
                                ></span
                                ><span class="mord"
                                  ><span class="mord text"
                                    ><span class="mord">otherwise</span></span
                                  ></span
                                ></span
                              ></span
                            ><span class="vlist-s">​</span></span
                          ><span class="vlist-r"
                            ><span class="vlist" style="height: 1.19em"
                              ><span></span></span></span></span></span></span></span
                  ><span
                    class="mclose nulldelimiter"
                  ></span></span></span></span></span
        ></span>
      </p>
      <blockquote>
        <p>
          这里的<span class="katex"
            ><span class="katex-mathml"
              ><math xmlns="http://www.w3.org/1998/Math/MathML"
                ><semantics
                  ><mrow
                    ><msub><mi>p</mi><mi>i</mi></msub></mrow
                  ><annotation encoding="application/x-tex"
                    >p_i</annotation
                  ></semantics
                ></math
              ></span
            ><span class="katex-html" aria-hidden="true"
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 0.625em; vertical-align: -0.1944em"
                ></span
                ><span class="mord"
                  ><span class="mord mathnormal">p</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.3117em"
                          ><span
                            style="
                              top: -2.55em;
                              margin-left: 0em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mord mathnormal mtight"
                                >i</span
                              ></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.15em"
                          ><span></span></span></span></span></span></span></span></span></span
          >和分类无关，因为训练这一部分的目的仅仅是生成高质量的 region
          proposal，不用关心类别。<br />
          两部分的归一化策略并不相同，因为其本身的任务衡量损失的方向不一样。前者需要平衡正负样本，后者需要统计整个图片的框的分布。
        </p>
      </blockquote>
      <p>对于边界框回归，有下面的参数化表示。</p>
      <p>对预测框：</p>
      <p>
        <span class="katex-display"
          ><span class="katex"
            ><span class="katex-mathml"
              ><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"
                ><semantics
                  ><mrow
                    ><msub><mi>t</mi><mi>x</mi></msub
                    ><mo>=</mo
                    ><mfrac
                      ><mrow
                        ><mi>x</mi><mo>−</mo
                        ><msub><mi>x</mi><mi>a</mi></msub></mrow
                      ><msub><mi>w</mi><mi>a</mi></msub></mfrac
                    ><mo separator="true">,</mo><msub><mi>t</mi><mi>y</mi></msub
                    ><mo>=</mo
                    ><mfrac
                      ><mrow
                        ><mi>y</mi><mo>−</mo
                        ><msub><mi>y</mi><mi>a</mi></msub></mrow
                      ><msub><mi>h</mi><mi>a</mi></msub></mfrac
                    ><mo separator="true">,</mo
                    ><mspace linebreak="newline"></mspace
                    ><msub><mi>t</mi><mi>w</mi></msub
                    ><mo>=</mo><mi>log</mi><mo>⁡</mo
                    ><mrow
                      ><mo fence="true">(</mo
                      ><mfrac
                        ><mi>w</mi><msub><mi>w</mi><mi>a</mi></msub></mfrac
                      ><mo fence="true">)</mo></mrow
                    ><mo separator="true">,</mo><msub><mi>t</mi><mi>h</mi></msub
                    ><mo>=</mo><mi>log</mi><mo>⁡</mo
                    ><mrow
                      ><mo fence="true">(</mo
                      ><mfrac
                        ><mi>h</mi><msub><mi>h</mi><mi>a</mi></msub></mfrac
                      ><mo fence="true">)</mo></mrow
                    ></mrow
                  ><annotation encoding="application/x-tex"
                    >t_x = \frac{x - x_a}{w_a}, t_y = \frac{y - y_a}{h_a}, \\
                    t_w = \log\left(\frac{w}{w_a}\right), t_h =
                    \log\left(\frac{h}{h_a}\right)</annotation
                  ></semantics
                ></math
              ></span
            ><span class="katex-html" aria-hidden="true"
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 0.7651em; vertical-align: -0.15em"
                ></span
                ><span class="mord"
                  ><span class="mord mathnormal">t</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.1514em"
                          ><span
                            style="
                              top: -2.55em;
                              margin-left: 0em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mord mathnormal mtight"
                                >x</span
                              ></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.15em"
                          ><span></span></span></span></span></span></span
                ><span class="mspace" style="margin-right: 0.2778em"></span
                ><span class="mrel">=</span
                ><span
                  class="mspace"
                  style="margin-right: 0.2778em"
                ></span></span
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 2.0963em; vertical-align: -0.836em"
                ></span
                ><span class="mord"
                  ><span class="mopen nulldelimiter"></span
                  ><span class="mfrac"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 1.2603em"
                          ><span style="top: -2.314em"
                            ><span class="pstrut" style="height: 3em"></span
                            ><span class="mord"
                              ><span class="mord"
                                ><span
                                  class="mord mathnormal"
                                  style="margin-right: 0.02691em"
                                  >w</span
                                ><span class="msupsub"
                                  ><span class="vlist-t vlist-t2"
                                    ><span class="vlist-r"
                                      ><span
                                        class="vlist"
                                        style="height: 0.1514em"
                                        ><span
                                          style="
                                            top: -2.55em;
                                            margin-left: -0.0269em;
                                            margin-right: 0.05em;
                                          "
                                          ><span
                                            class="pstrut"
                                            style="height: 2.7em"
                                          ></span
                                          ><span
                                            class="sizing reset-size6 size3 mtight"
                                            ><span
                                              class="mord mathnormal mtight"
                                              >a</span
                                            ></span
                                          ></span
                                        ></span
                                      ><span class="vlist-s">​</span></span
                                    ><span class="vlist-r"
                                      ><span
                                        class="vlist"
                                        style="height: 0.15em"
                                        ><span></span></span></span></span></span></span></span></span
                          ><span style="top: -3.23em"
                            ><span class="pstrut" style="height: 3em"></span
                            ><span
                              class="frac-line"
                              style="border-bottom-width: 0.04em"
                            ></span></span
                          ><span style="top: -3.677em"
                            ><span class="pstrut" style="height: 3em"></span
                            ><span class="mord"
                              ><span class="mord mathnormal">x</span
                              ><span
                                class="mspace"
                                style="margin-right: 0.2222em"
                              ></span
                              ><span class="mbin">−</span
                              ><span
                                class="mspace"
                                style="margin-right: 0.2222em"
                              ></span
                              ><span class="mord"
                                ><span class="mord mathnormal">x</span
                                ><span class="msupsub"
                                  ><span class="vlist-t vlist-t2"
                                    ><span class="vlist-r"
                                      ><span
                                        class="vlist"
                                        style="height: 0.1514em"
                                        ><span
                                          style="
                                            top: -2.55em;
                                            margin-left: 0em;
                                            margin-right: 0.05em;
                                          "
                                          ><span
                                            class="pstrut"
                                            style="height: 2.7em"
                                          ></span
                                          ><span
                                            class="sizing reset-size6 size3 mtight"
                                            ><span
                                              class="mord mathnormal mtight"
                                              >a</span
                                            ></span
                                          ></span
                                        ></span
                                      ><span class="vlist-s">​</span></span
                                    ><span class="vlist-r"
                                      ><span
                                        class="vlist"
                                        style="height: 0.15em"
                                        ><span></span></span></span></span></span></span></span></span></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.836em"
                          ><span></span></span></span></span></span
                  ><span class="mclose nulldelimiter"></span></span
                ><span class="mpunct">,</span
                ><span class="mspace" style="margin-right: 0.1667em"></span
                ><span class="mord"
                  ><span class="mord mathnormal">t</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.1514em"
                          ><span
                            style="
                              top: -2.55em;
                              margin-left: 0em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span
                                class="mord mathnormal mtight"
                                style="margin-right: 0.03588em"
                                >y</span
                              ></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.2861em"
                          ><span></span></span></span></span></span></span
                ><span class="mspace" style="margin-right: 0.2778em"></span
                ><span class="mrel">=</span
                ><span
                  class="mspace"
                  style="margin-right: 0.2778em"
                ></span></span
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 2.0963em; vertical-align: -0.836em"
                ></span
                ><span class="mord"
                  ><span class="mopen nulldelimiter"></span
                  ><span class="mfrac"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 1.2603em"
                          ><span style="top: -2.314em"
                            ><span class="pstrut" style="height: 3em"></span
                            ><span class="mord"
                              ><span class="mord"
                                ><span class="mord mathnormal">h</span
                                ><span class="msupsub"
                                  ><span class="vlist-t vlist-t2"
                                    ><span class="vlist-r"
                                      ><span
                                        class="vlist"
                                        style="height: 0.1514em"
                                        ><span
                                          style="
                                            top: -2.55em;
                                            margin-left: 0em;
                                            margin-right: 0.05em;
                                          "
                                          ><span
                                            class="pstrut"
                                            style="height: 2.7em"
                                          ></span
                                          ><span
                                            class="sizing reset-size6 size3 mtight"
                                            ><span
                                              class="mord mathnormal mtight"
                                              >a</span
                                            ></span
                                          ></span
                                        ></span
                                      ><span class="vlist-s">​</span></span
                                    ><span class="vlist-r"
                                      ><span
                                        class="vlist"
                                        style="height: 0.15em"
                                        ><span></span></span></span></span></span></span></span></span
                          ><span style="top: -3.23em"
                            ><span class="pstrut" style="height: 3em"></span
                            ><span
                              class="frac-line"
                              style="border-bottom-width: 0.04em"
                            ></span></span
                          ><span style="top: -3.677em"
                            ><span class="pstrut" style="height: 3em"></span
                            ><span class="mord"
                              ><span
                                class="mord mathnormal"
                                style="margin-right: 0.03588em"
                                >y</span
                              ><span
                                class="mspace"
                                style="margin-right: 0.2222em"
                              ></span
                              ><span class="mbin">−</span
                              ><span
                                class="mspace"
                                style="margin-right: 0.2222em"
                              ></span
                              ><span class="mord"
                                ><span
                                  class="mord mathnormal"
                                  style="margin-right: 0.03588em"
                                  >y</span
                                ><span class="msupsub"
                                  ><span class="vlist-t vlist-t2"
                                    ><span class="vlist-r"
                                      ><span
                                        class="vlist"
                                        style="height: 0.1514em"
                                        ><span
                                          style="
                                            top: -2.55em;
                                            margin-left: -0.0359em;
                                            margin-right: 0.05em;
                                          "
                                          ><span
                                            class="pstrut"
                                            style="height: 2.7em"
                                          ></span
                                          ><span
                                            class="sizing reset-size6 size3 mtight"
                                            ><span
                                              class="mord mathnormal mtight"
                                              >a</span
                                            ></span
                                          ></span
                                        ></span
                                      ><span class="vlist-s">​</span></span
                                    ><span class="vlist-r"
                                      ><span
                                        class="vlist"
                                        style="height: 0.15em"
                                        ><span></span></span></span></span></span></span></span></span></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.836em"
                          ><span></span></span></span></span></span
                  ><span class="mclose nulldelimiter"></span></span
                ><span class="mpunct">,</span></span
              ><span class="mspace newline"></span
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 0.7651em; vertical-align: -0.15em"
                ></span
                ><span class="mord"
                  ><span class="mord mathnormal">t</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.1514em"
                          ><span
                            style="
                              top: -2.55em;
                              margin-left: 0em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span
                                class="mord mathnormal mtight"
                                style="margin-right: 0.02691em"
                                >w</span
                              ></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.15em"
                          ><span></span></span></span></span></span></span
                ><span class="mspace" style="margin-right: 0.2778em"></span
                ><span class="mrel">=</span
                ><span
                  class="mspace"
                  style="margin-right: 0.2778em"
                ></span></span
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 2.4em; vertical-align: -0.95em"
                ></span
                ><span class="mop"
                  >lo<span style="margin-right: 0.01389em">g</span></span
                ><span class="mspace" style="margin-right: 0.1667em"></span
                ><span class="minner"
                  ><span class="mopen delimcenter" style="top: 0em"
                    ><span class="delimsizing size3">(</span></span
                  ><span class="mord"
                    ><span class="mopen nulldelimiter"></span
                    ><span class="mfrac"
                      ><span class="vlist-t vlist-t2"
                        ><span class="vlist-r"
                          ><span class="vlist" style="height: 1.1076em"
                            ><span style="top: -2.314em"
                              ><span class="pstrut" style="height: 3em"></span
                              ><span class="mord"
                                ><span class="mord"
                                  ><span
                                    class="mord mathnormal"
                                    style="margin-right: 0.02691em"
                                    >w</span
                                  ><span class="msupsub"
                                    ><span class="vlist-t vlist-t2"
                                      ><span class="vlist-r"
                                        ><span
                                          class="vlist"
                                          style="height: 0.1514em"
                                          ><span
                                            style="
                                              top: -2.55em;
                                              margin-left: -0.0269em;
                                              margin-right: 0.05em;
                                            "
                                            ><span
                                              class="pstrut"
                                              style="height: 2.7em"
                                            ></span
                                            ><span
                                              class="sizing reset-size6 size3 mtight"
                                              ><span
                                                class="mord mathnormal mtight"
                                                >a</span
                                              ></span
                                            ></span
                                          ></span
                                        ><span class="vlist-s">​</span></span
                                      ><span class="vlist-r"
                                        ><span
                                          class="vlist"
                                          style="height: 0.15em"
                                          ><span></span></span></span></span></span></span></span></span
                            ><span style="top: -3.23em"
                              ><span class="pstrut" style="height: 3em"></span
                              ><span
                                class="frac-line"
                                style="border-bottom-width: 0.04em"
                              ></span></span
                            ><span style="top: -3.677em"
                              ><span class="pstrut" style="height: 3em"></span
                              ><span class="mord"
                                ><span
                                  class="mord mathnormal"
                                  style="margin-right: 0.02691em"
                                  >w</span
                                ></span
                              ></span
                            ></span
                          ><span class="vlist-s">​</span></span
                        ><span class="vlist-r"
                          ><span class="vlist" style="height: 0.836em"
                            ><span></span></span></span></span></span
                    ><span class="mclose nulldelimiter"></span></span
                  ><span class="mclose delimcenter" style="top: 0em"
                    ><span class="delimsizing size3">)</span></span
                  ></span
                ><span class="mspace" style="margin-right: 0.1667em"></span
                ><span class="mpunct">,</span
                ><span class="mspace" style="margin-right: 0.1667em"></span
                ><span class="mord"
                  ><span class="mord mathnormal">t</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.3361em"
                          ><span
                            style="
                              top: -2.55em;
                              margin-left: 0em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mord mathnormal mtight"
                                >h</span
                              ></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.15em"
                          ><span></span></span></span></span></span></span
                ><span class="mspace" style="margin-right: 0.2778em"></span
                ><span class="mrel">=</span
                ><span
                  class="mspace"
                  style="margin-right: 0.2778em"
                ></span></span
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 2.4em; vertical-align: -0.95em"
                ></span
                ><span class="mop"
                  >lo<span style="margin-right: 0.01389em">g</span></span
                ><span class="mspace" style="margin-right: 0.1667em"></span
                ><span class="minner"
                  ><span class="mopen delimcenter" style="top: 0em"
                    ><span class="delimsizing size3">(</span></span
                  ><span class="mord"
                    ><span class="mopen nulldelimiter"></span
                    ><span class="mfrac"
                      ><span class="vlist-t vlist-t2"
                        ><span class="vlist-r"
                          ><span class="vlist" style="height: 1.3714em"
                            ><span style="top: -2.314em"
                              ><span class="pstrut" style="height: 3em"></span
                              ><span class="mord"
                                ><span class="mord"
                                  ><span class="mord mathnormal">h</span
                                  ><span class="msupsub"
                                    ><span class="vlist-t vlist-t2"
                                      ><span class="vlist-r"
                                        ><span
                                          class="vlist"
                                          style="height: 0.1514em"
                                          ><span
                                            style="
                                              top: -2.55em;
                                              margin-left: 0em;
                                              margin-right: 0.05em;
                                            "
                                            ><span
                                              class="pstrut"
                                              style="height: 2.7em"
                                            ></span
                                            ><span
                                              class="sizing reset-size6 size3 mtight"
                                              ><span
                                                class="mord mathnormal mtight"
                                                >a</span
                                              ></span
                                            ></span
                                          ></span
                                        ><span class="vlist-s">​</span></span
                                      ><span class="vlist-r"
                                        ><span
                                          class="vlist"
                                          style="height: 0.15em"
                                          ><span></span></span></span></span></span></span></span></span
                            ><span style="top: -3.23em"
                              ><span class="pstrut" style="height: 3em"></span
                              ><span
                                class="frac-line"
                                style="border-bottom-width: 0.04em"
                              ></span></span
                            ><span style="top: -3.677em"
                              ><span class="pstrut" style="height: 3em"></span
                              ><span class="mord"
                                ><span class="mord mathnormal">h</span></span
                              ></span
                            ></span
                          ><span class="vlist-s">​</span></span
                        ><span class="vlist-r"
                          ><span class="vlist" style="height: 0.836em"
                            ><span></span></span></span></span></span
                    ><span class="mclose nulldelimiter"></span></span
                  ><span class="mclose delimcenter" style="top: 0em"
                    ><span class="delimsizing size3">)</span></span
                  ></span
                ></span
              ></span
            ></span
          ></span
        >
      </p>
      <p>对真实框：</p>
      <p>
        <span class="katex-display"
          ><span class="katex"
            ><span class="katex-mathml"
              ><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"
                ><semantics
                  ><mrow
                    ><msubsup><mi>t</mi><mi>x</mi><mo>∗</mo></msubsup
                    ><mo>=</mo
                    ><mfrac
                      ><mrow
                        ><msup><mi>x</mi><mo>∗</mo></msup
                        ><mo>−</mo><msub><mi>x</mi><mi>a</mi></msub></mrow
                      ><msub><mi>w</mi><mi>a</mi></msub></mfrac
                    ><mo separator="true">,</mo
                    ><msubsup><mi>t</mi><mi>y</mi><mo>∗</mo></msubsup
                    ><mo>=</mo
                    ><mfrac
                      ><mrow
                        ><msup><mi>y</mi><mo>∗</mo></msup
                        ><mo>−</mo><msub><mi>y</mi><mi>a</mi></msub></mrow
                      ><msub><mi>h</mi><mi>a</mi></msub></mfrac
                    ><mo separator="true">,</mo
                    ><mspace linebreak="newline"></mspace
                    ><msubsup><mi>t</mi><mi>w</mi><mo>∗</mo></msubsup
                    ><mo>=</mo><mi>log</mi><mo>⁡</mo
                    ><mrow
                      ><mo fence="true">(</mo
                      ><mfrac
                        ><msup><mi>w</mi><mo>∗</mo></msup
                        ><msub><mi>w</mi><mi>a</mi></msub></mfrac
                      ><mo fence="true">)</mo></mrow
                    ><mo separator="true">,</mo
                    ><msubsup><mi>t</mi><mi>h</mi><mo>∗</mo></msubsup
                    ><mo>=</mo><mi>log</mi><mo>⁡</mo
                    ><mrow
                      ><mo fence="true">(</mo
                      ><mfrac
                        ><msup><mi>h</mi><mo>∗</mo></msup
                        ><msub><mi>h</mi><mi>a</mi></msub></mfrac
                      ><mo fence="true">)</mo></mrow
                    ></mrow
                  ><annotation encoding="application/x-tex"
                    >t^*_x = \frac{x^* - x_a}{w_a}, t^*_y = \frac{y^* -
                    y_a}{h_a}, \\ t^*_w = \log\left(\frac{w^*}{w_a}\right),
                    t^*_h = \log\left(\frac{h^*}{h_a}\right)</annotation
                  ></semantics
                ></math
              ></span
            ><span class="katex-html" aria-hidden="true"
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 0.9857em; vertical-align: -0.247em"
                ></span
                ><span class="mord"
                  ><span class="mord mathnormal">t</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.7387em"
                          ><span
                            style="
                              top: -2.453em;
                              margin-left: 0em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mord mathnormal mtight"
                                >x</span
                              ></span
                            ></span
                          ><span style="top: -3.113em; margin-right: 0.05em"
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mbin mtight">∗</span></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.247em"
                          ><span></span></span></span></span></span></span
                ><span class="mspace" style="margin-right: 0.2778em"></span
                ><span class="mrel">=</span
                ><span
                  class="mspace"
                  style="margin-right: 0.2778em"
                ></span></span
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 2.2017em; vertical-align: -0.836em"
                ></span
                ><span class="mord"
                  ><span class="mopen nulldelimiter"></span
                  ><span class="mfrac"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 1.3657em"
                          ><span style="top: -2.314em"
                            ><span class="pstrut" style="height: 3em"></span
                            ><span class="mord"
                              ><span class="mord"
                                ><span
                                  class="mord mathnormal"
                                  style="margin-right: 0.02691em"
                                  >w</span
                                ><span class="msupsub"
                                  ><span class="vlist-t vlist-t2"
                                    ><span class="vlist-r"
                                      ><span
                                        class="vlist"
                                        style="height: 0.1514em"
                                        ><span
                                          style="
                                            top: -2.55em;
                                            margin-left: -0.0269em;
                                            margin-right: 0.05em;
                                          "
                                          ><span
                                            class="pstrut"
                                            style="height: 2.7em"
                                          ></span
                                          ><span
                                            class="sizing reset-size6 size3 mtight"
                                            ><span
                                              class="mord mathnormal mtight"
                                              >a</span
                                            ></span
                                          ></span
                                        ></span
                                      ><span class="vlist-s">​</span></span
                                    ><span class="vlist-r"
                                      ><span
                                        class="vlist"
                                        style="height: 0.15em"
                                        ><span></span></span></span></span></span></span></span></span
                          ><span style="top: -3.23em"
                            ><span class="pstrut" style="height: 3em"></span
                            ><span
                              class="frac-line"
                              style="border-bottom-width: 0.04em"
                            ></span></span
                          ><span style="top: -3.677em"
                            ><span class="pstrut" style="height: 3em"></span
                            ><span class="mord"
                              ><span class="mord"
                                ><span class="mord mathnormal">x</span
                                ><span class="msupsub"
                                  ><span class="vlist-t"
                                    ><span class="vlist-r"
                                      ><span
                                        class="vlist"
                                        style="height: 0.6887em"
                                        ><span
                                          style="
                                            top: -3.063em;
                                            margin-right: 0.05em;
                                          "
                                          ><span
                                            class="pstrut"
                                            style="height: 2.7em"
                                          ></span
                                          ><span
                                            class="sizing reset-size6 size3 mtight"
                                            ><span class="mbin mtight"
                                              >∗</span
                                            ></span
                                          ></span
                                        ></span
                                      ></span
                                    ></span
                                  ></span
                                ></span
                              ><span
                                class="mspace"
                                style="margin-right: 0.2222em"
                              ></span
                              ><span class="mbin">−</span
                              ><span
                                class="mspace"
                                style="margin-right: 0.2222em"
                              ></span
                              ><span class="mord"
                                ><span class="mord mathnormal">x</span
                                ><span class="msupsub"
                                  ><span class="vlist-t vlist-t2"
                                    ><span class="vlist-r"
                                      ><span
                                        class="vlist"
                                        style="height: 0.1514em"
                                        ><span
                                          style="
                                            top: -2.55em;
                                            margin-left: 0em;
                                            margin-right: 0.05em;
                                          "
                                          ><span
                                            class="pstrut"
                                            style="height: 2.7em"
                                          ></span
                                          ><span
                                            class="sizing reset-size6 size3 mtight"
                                            ><span
                                              class="mord mathnormal mtight"
                                              >a</span
                                            ></span
                                          ></span
                                        ></span
                                      ><span class="vlist-s">​</span></span
                                    ><span class="vlist-r"
                                      ><span
                                        class="vlist"
                                        style="height: 0.15em"
                                        ><span></span></span></span></span></span></span></span></span></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.836em"
                          ><span></span></span></span></span></span
                  ><span class="mclose nulldelimiter"></span></span
                ><span class="mpunct">,</span
                ><span class="mspace" style="margin-right: 0.1667em"></span
                ><span class="mord"
                  ><span class="mord mathnormal">t</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.7387em"
                          ><span
                            style="
                              top: -2.453em;
                              margin-left: 0em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span
                                class="mord mathnormal mtight"
                                style="margin-right: 0.03588em"
                                >y</span
                              ></span
                            ></span
                          ><span style="top: -3.113em; margin-right: 0.05em"
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mbin mtight">∗</span></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.3831em"
                          ><span></span></span></span></span></span></span
                ><span class="mspace" style="margin-right: 0.2778em"></span
                ><span class="mrel">=</span
                ><span
                  class="mspace"
                  style="margin-right: 0.2778em"
                ></span></span
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 2.2017em; vertical-align: -0.836em"
                ></span
                ><span class="mord"
                  ><span class="mopen nulldelimiter"></span
                  ><span class="mfrac"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 1.3657em"
                          ><span style="top: -2.314em"
                            ><span class="pstrut" style="height: 3em"></span
                            ><span class="mord"
                              ><span class="mord"
                                ><span class="mord mathnormal">h</span
                                ><span class="msupsub"
                                  ><span class="vlist-t vlist-t2"
                                    ><span class="vlist-r"
                                      ><span
                                        class="vlist"
                                        style="height: 0.1514em"
                                        ><span
                                          style="
                                            top: -2.55em;
                                            margin-left: 0em;
                                            margin-right: 0.05em;
                                          "
                                          ><span
                                            class="pstrut"
                                            style="height: 2.7em"
                                          ></span
                                          ><span
                                            class="sizing reset-size6 size3 mtight"
                                            ><span
                                              class="mord mathnormal mtight"
                                              >a</span
                                            ></span
                                          ></span
                                        ></span
                                      ><span class="vlist-s">​</span></span
                                    ><span class="vlist-r"
                                      ><span
                                        class="vlist"
                                        style="height: 0.15em"
                                        ><span></span></span></span></span></span></span></span></span
                          ><span style="top: -3.23em"
                            ><span class="pstrut" style="height: 3em"></span
                            ><span
                              class="frac-line"
                              style="border-bottom-width: 0.04em"
                            ></span></span
                          ><span style="top: -3.677em"
                            ><span class="pstrut" style="height: 3em"></span
                            ><span class="mord"
                              ><span class="mord"
                                ><span
                                  class="mord mathnormal"
                                  style="margin-right: 0.03588em"
                                  >y</span
                                ><span class="msupsub"
                                  ><span class="vlist-t"
                                    ><span class="vlist-r"
                                      ><span
                                        class="vlist"
                                        style="height: 0.6887em"
                                        ><span
                                          style="
                                            top: -3.063em;
                                            margin-right: 0.05em;
                                          "
                                          ><span
                                            class="pstrut"
                                            style="height: 2.7em"
                                          ></span
                                          ><span
                                            class="sizing reset-size6 size3 mtight"
                                            ><span class="mbin mtight"
                                              >∗</span
                                            ></span
                                          ></span
                                        ></span
                                      ></span
                                    ></span
                                  ></span
                                ></span
                              ><span
                                class="mspace"
                                style="margin-right: 0.2222em"
                              ></span
                              ><span class="mbin">−</span
                              ><span
                                class="mspace"
                                style="margin-right: 0.2222em"
                              ></span
                              ><span class="mord"
                                ><span
                                  class="mord mathnormal"
                                  style="margin-right: 0.03588em"
                                  >y</span
                                ><span class="msupsub"
                                  ><span class="vlist-t vlist-t2"
                                    ><span class="vlist-r"
                                      ><span
                                        class="vlist"
                                        style="height: 0.1514em"
                                        ><span
                                          style="
                                            top: -2.55em;
                                            margin-left: -0.0359em;
                                            margin-right: 0.05em;
                                          "
                                          ><span
                                            class="pstrut"
                                            style="height: 2.7em"
                                          ></span
                                          ><span
                                            class="sizing reset-size6 size3 mtight"
                                            ><span
                                              class="mord mathnormal mtight"
                                              >a</span
                                            ></span
                                          ></span
                                        ></span
                                      ><span class="vlist-s">​</span></span
                                    ><span class="vlist-r"
                                      ><span
                                        class="vlist"
                                        style="height: 0.15em"
                                        ><span></span></span></span></span></span></span></span></span></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.836em"
                          ><span></span></span></span></span></span
                  ><span class="mclose nulldelimiter"></span></span
                ><span class="mpunct">,</span></span
              ><span class="mspace newline"></span
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 0.9857em; vertical-align: -0.247em"
                ></span
                ><span class="mord"
                  ><span class="mord mathnormal">t</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.7387em"
                          ><span
                            style="
                              top: -2.453em;
                              margin-left: 0em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span
                                class="mord mathnormal mtight"
                                style="margin-right: 0.02691em"
                                >w</span
                              ></span
                            ></span
                          ><span style="top: -3.113em; margin-right: 0.05em"
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mbin mtight">∗</span></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.247em"
                          ><span></span></span></span></span></span></span
                ><span class="mspace" style="margin-right: 0.2778em"></span
                ><span class="mrel">=</span
                ><span
                  class="mspace"
                  style="margin-right: 0.2778em"
                ></span></span
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 2.4em; vertical-align: -0.95em"
                ></span
                ><span class="mop"
                  >lo<span style="margin-right: 0.01389em">g</span></span
                ><span class="mspace" style="margin-right: 0.1667em"></span
                ><span class="minner"
                  ><span class="mopen delimcenter" style="top: 0em"
                    ><span class="delimsizing size3">(</span></span
                  ><span class="mord"
                    ><span class="mopen nulldelimiter"></span
                    ><span class="mfrac"
                      ><span class="vlist-t vlist-t2"
                        ><span class="vlist-r"
                          ><span class="vlist" style="height: 1.3657em"
                            ><span style="top: -2.314em"
                              ><span class="pstrut" style="height: 3em"></span
                              ><span class="mord"
                                ><span class="mord"
                                  ><span
                                    class="mord mathnormal"
                                    style="margin-right: 0.02691em"
                                    >w</span
                                  ><span class="msupsub"
                                    ><span class="vlist-t vlist-t2"
                                      ><span class="vlist-r"
                                        ><span
                                          class="vlist"
                                          style="height: 0.1514em"
                                          ><span
                                            style="
                                              top: -2.55em;
                                              margin-left: -0.0269em;
                                              margin-right: 0.05em;
                                            "
                                            ><span
                                              class="pstrut"
                                              style="height: 2.7em"
                                            ></span
                                            ><span
                                              class="sizing reset-size6 size3 mtight"
                                              ><span
                                                class="mord mathnormal mtight"
                                                >a</span
                                              ></span
                                            ></span
                                          ></span
                                        ><span class="vlist-s">​</span></span
                                      ><span class="vlist-r"
                                        ><span
                                          class="vlist"
                                          style="height: 0.15em"
                                          ><span></span></span></span></span></span></span></span></span
                            ><span style="top: -3.23em"
                              ><span class="pstrut" style="height: 3em"></span
                              ><span
                                class="frac-line"
                                style="border-bottom-width: 0.04em"
                              ></span></span
                            ><span style="top: -3.677em"
                              ><span class="pstrut" style="height: 3em"></span
                              ><span class="mord"
                                ><span class="mord"
                                  ><span
                                    class="mord mathnormal"
                                    style="margin-right: 0.02691em"
                                    >w</span
                                  ><span class="msupsub"
                                    ><span class="vlist-t"
                                      ><span class="vlist-r"
                                        ><span
                                          class="vlist"
                                          style="height: 0.6887em"
                                          ><span
                                            style="
                                              top: -3.063em;
                                              margin-right: 0.05em;
                                            "
                                            ><span
                                              class="pstrut"
                                              style="height: 2.7em"
                                            ></span
                                            ><span
                                              class="sizing reset-size6 size3 mtight"
                                              ><span class="mbin mtight"
                                                >∗</span
                                              ></span
                                            ></span
                                          ></span
                                        ></span
                                      ></span
                                    ></span
                                  ></span
                                ></span
                              ></span
                            ></span
                          ><span class="vlist-s">​</span></span
                        ><span class="vlist-r"
                          ><span class="vlist" style="height: 0.836em"
                            ><span></span></span></span></span></span
                    ><span class="mclose nulldelimiter"></span></span
                  ><span class="mclose delimcenter" style="top: 0em"
                    ><span class="delimsizing size3">)</span></span
                  ></span
                ><span class="mspace" style="margin-right: 0.1667em"></span
                ><span class="mpunct">,</span
                ><span class="mspace" style="margin-right: 0.1667em"></span
                ><span class="mord"
                  ><span class="mord mathnormal">t</span
                  ><span class="msupsub"
                    ><span class="vlist-t vlist-t2"
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.7387em"
                          ><span
                            style="
                              top: -2.453em;
                              margin-left: 0em;
                              margin-right: 0.05em;
                            "
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mord mathnormal mtight"
                                >h</span
                              ></span
                            ></span
                          ><span style="top: -3.113em; margin-right: 0.05em"
                            ><span class="pstrut" style="height: 2.7em"></span
                            ><span class="sizing reset-size6 size3 mtight"
                              ><span class="mbin mtight">∗</span></span
                            ></span
                          ></span
                        ><span class="vlist-s">​</span></span
                      ><span class="vlist-r"
                        ><span class="vlist" style="height: 0.247em"
                          ><span></span></span></span></span></span></span
                ><span class="mspace" style="margin-right: 0.2778em"></span
                ><span class="mrel">=</span
                ><span
                  class="mspace"
                  style="margin-right: 0.2778em"
                ></span></span
              ><span class="base"
                ><span
                  class="strut"
                  style="height: 2.4em; vertical-align: -0.95em"
                ></span
                ><span class="mop"
                  >lo<span style="margin-right: 0.01389em">g</span></span
                ><span class="mspace" style="margin-right: 0.1667em"></span
                ><span class="minner"
                  ><span class="mopen delimcenter" style="top: 0em"
                    ><span class="delimsizing size3">(</span></span
                  ><span class="mord"
                    ><span class="mopen nulldelimiter"></span
                    ><span class="mfrac"
                      ><span class="vlist-t vlist-t2"
                        ><span class="vlist-r"
                          ><span class="vlist" style="height: 1.3714em"
                            ><span style="top: -2.314em"
                              ><span class="pstrut" style="height: 3em"></span
                              ><span class="mord"
                                ><span class="mord"
                                  ><span class="mord mathnormal">h</span
                                  ><span class="msupsub"
                                    ><span class="vlist-t vlist-t2"
                                      ><span class="vlist-r"
                                        ><span
                                          class="vlist"
                                          style="height: 0.1514em"
                                          ><span
                                            style="
                                              top: -2.55em;
                                              margin-left: 0em;
                                              margin-right: 0.05em;
                                            "
                                            ><span
                                              class="pstrut"
                                              style="height: 2.7em"
                                            ></span
                                            ><span
                                              class="sizing reset-size6 size3 mtight"
                                              ><span
                                                class="mord mathnormal mtight"
                                                >a</span
                                              ></span
                                            ></span
                                          ></span
                                        ><span class="vlist-s">​</span></span
                                      ><span class="vlist-r"
                                        ><span
                                          class="vlist"
                                          style="height: 0.15em"
                                          ><span></span></span></span></span></span></span></span></span
                            ><span style="top: -3.23em"
                              ><span class="pstrut" style="height: 3em"></span
                              ><span
                                class="frac-line"
                                style="border-bottom-width: 0.04em"
                              ></span></span
                            ><span style="top: -3.677em"
                              ><span class="pstrut" style="height: 3em"></span
                              ><span class="mord"
                                ><span class="mord"
                                  ><span class="mord mathnormal">h</span
                                  ><span class="msupsub"
                                    ><span class="vlist-t"
                                      ><span class="vlist-r"
                                        ><span
                                          class="vlist"
                                          style="height: 0.6887em"
                                          ><span
                                            style="
                                              top: -3.063em;
                                              margin-right: 0.05em;
                                            "
                                            ><span
                                              class="pstrut"
                                              style="height: 2.7em"
                                            ></span
                                            ><span
                                              class="sizing reset-size6 size3 mtight"
                                              ><span class="mbin mtight"
                                                >∗</span
                                              ></span
                                            ></span
                                          ></span
                                        ></span
                                      ></span
                                    ></span
                                  ></span
                                ></span
                              ></span
                            ></span
                          ><span class="vlist-s">​</span></span
                        ><span class="vlist-r"
                          ><span class="vlist" style="height: 0.836em"
                            ><span></span></span></span></span></span
                    ><span class="mclose nulldelimiter"></span></span
                  ><span class="mclose delimcenter" style="top: 0em"
                    ><span class="delimsizing size3">)</span></span
                  ></span
                ></span
              ></span
            ></span
          ></span
        >
      </p>
      <p>
        所有带下标<span class="katex"
          ><span class="katex-mathml"
            ><math xmlns="http://www.w3.org/1998/Math/MathML"
              ><semantics
                ><mrow
                  ><msub><mrow></mrow><mi>a</mi></msub></mrow
                ><annotation encoding="application/x-tex"
                  >_a</annotation
                ></semantics
              ></math
            ></span
          ><span class="katex-html" aria-hidden="true"
            ><span class="base"
              ><span
                class="strut"
                style="height: 0.3014em; vertical-align: -0.15em"
              ></span
              ><span class="mord"
                ><span></span
                ><span class="msupsub"
                  ><span class="vlist-t vlist-t2"
                    ><span class="vlist-r"
                      ><span class="vlist" style="height: 0.1514em"
                        ><span style="top: -2.55em; margin-right: 0.05em"
                          ><span class="pstrut" style="height: 2.7em"></span
                          ><span class="sizing reset-size6 size3 mtight"
                            ><span class="mord mathnormal mtight">a</span></span
                          ></span
                        ></span
                      ><span class="vlist-s">​</span></span
                    ><span class="vlist-r"
                      ><span class="vlist" style="height: 0.15em"
                        ><span></span></span></span></span></span></span></span></span></span
        >的都是锚框的参数，相当于和锚框的相对偏移量。除以锚框的宽和高是为了实现尺度不变性。
      </p>
      <blockquote>
        <p>
          Fast R-CNN 的 RPN 的边界框回归和先前基于 RoI
          的方法的差异：对特征处理不池化，直接在固定尺寸的特征图上滑动
          filter，并且不同尺度和长宽比的锚框使用不同的
          filter。这样不会因为池化丢弃细节，同时也能区分尺度不同的物体。
        </p>
      </blockquote>
      <h4 id="rpn-的训练">RPN 的训练</h4>
      <p>用经典的 SGD 训练。采样策略是 Fast R-CNN 的“image-centric”。</p>
      <blockquote>
        <p>
          image-centric：以单张图像为单位构建
          mini-batch，通过平衡正负样本比例来高效训练模型。每张图片采样固定数量的锚框组成一个
          mini-batch，并且优先正采样，让正负样本数量趋于
          1:1（如果不这样做的话会采样到很多背景的负采样）。
        </p>
      </blockquote>
      <p>
        新提出的层用均值为
        <span class="katex"
          ><span class="katex-mathml"
            ><math xmlns="http://www.w3.org/1998/Math/MathML"
              ><semantics
                ><mrow><mi>μ</mi><mo>=</mo><mn>0</mn></mrow
                ><annotation encoding="application/x-tex"
                  >\mu = 0</annotation
                ></semantics
              ></math
            ></span
          ><span class="katex-html" aria-hidden="true"
            ><span class="base"
              ><span
                class="strut"
                style="height: 0.625em; vertical-align: -0.1944em"
              ></span
              ><span class="mord mathnormal">μ</span
              ><span class="mspace" style="margin-right: 0.2778em"></span
              ><span class="mrel">=</span
              ><span class="mspace" style="margin-right: 0.2778em"></span></span
            ><span class="base"
              ><span class="strut" style="height: 0.6444em"></span
              ><span class="mord">0</span></span
            ></span
          ></span
        >，标准差为
        <span class="katex"
          ><span class="katex-mathml"
            ><math xmlns="http://www.w3.org/1998/Math/MathML"
              ><semantics
                ><mrow><mi>σ</mi><mo>=</mo><mn>0.01</mn></mrow
                ><annotation encoding="application/x-tex"
                  >\sigma = 0.01</annotation
                ></semantics
              ></math
            ></span
          ><span class="katex-html" aria-hidden="true"
            ><span class="base"
              ><span class="strut" style="height: 0.4306em"></span
              ><span class="mord mathnormal" style="margin-right: 0.03588em"
                >σ</span
              ><span class="mspace" style="margin-right: 0.2778em"></span
              ><span class="mrel">=</span
              ><span class="mspace" style="margin-right: 0.2778em"></span></span
            ><span class="base"
              ><span class="strut" style="height: 0.6444em"></span
              ><span class="mord">0.01</span></span
            ></span
          ></span
        >
        的高斯分布随机初始化权重参数。共享的卷积层（传统的层）和标准做法相同。<br />
        底层卷积层的作用是学习特征，这些特征可以用于迁移学习。所以直接用
        ImageNet 上训练好的模型初始化。
      </p>
      <h3 id="rpn-和-fast-r-cnn-的共享特征">RPN 和 Fast R-CNN 的共享特征</h3>
      <p>
        检测网络使用的是 Fast R-CNN。RPN
        和检测网络修改卷积的方式看起来是不一样的，那它们如何共享卷积层呢？方法有三：
      </p>
      <ol>
        <li>
          交替训练<br />
          先训练 RPN，再用 RPN 生成 region proposal 来训练 Fast
          R-CNN，再用优化后的 Fast R-CNN 初始化 RPN……循环往复。
        </li>
        <li>
          近似联合训练<br />
          把两个网络合并在一起，前向传播时产生 region
          proposal，<strong>被视为固有的</strong>用来训练 Fast
          R-CNN。反向传播的时候，梯度不反向传播到 RPN 的候选生成部分——即 Fast
          R-CNN 的梯度仅影响自身和共享卷积层部分，RPN
          的更新通过上述的分类和回归损失更新。
          <blockquote>
            <p>
              这里的“近似”，指的是忽略了 NMS
              的反向传播，而且候选框的坐标已经被固定了。
            </p>
          </blockquote>
        </li>
        <li>
          非近似联合训练<br />
          RPN 预测的边界框实际上也属于输入的函数，RoI 层同时接受卷积特征和
          region proposal
          作为输入，反向传播理应包含它们的梯度，所以需要一个与框坐标可微分的 RoI
          池化层。这个问题并不在本文讨论的范围。
        </li>
      </ol>
      <h4 id="四步交替训练">四步交替训练</h4>
      <p>
        训练 RPN（端到端微调）<span class="katex"
          ><span class="katex-mathml"
            ><math xmlns="http://www.w3.org/1998/Math/MathML"
              ><semantics
                ><mrow
                  ><mover
                    ><mo stretchy="true" minsize="3.0em">→</mo
                    ><mpadded width="+0.6em" lspace="0.3em"
                      ><mtext>得到region&nbsp;proposal</mtext></mpadded
                    ></mover
                  ></mrow
                ><annotation encoding="application/x-tex"
                  >\xrightarrow{\text{得到region proposal}}</annotation
                ></semantics
              ></math
            ></span
          ><span class="katex-html" aria-hidden="true"
            ><span class="base"
              ><span
                class="strut"
                style="height: 1.1191em; vertical-align: -0.011em"
              ></span
              ><span class="mrel x-arrow"
                ><span class="vlist-t vlist-t2"
                  ><span class="vlist-r"
                    ><span class="vlist" style="height: 1.1081em"
                      ><span style="top: -3.322em"
                        ><span class="pstrut" style="height: 2.7em"></span
                        ><span
                          class="sizing reset-size6 size3 mtight x-arrow-pad"
                          ><span class="mord mtight"
                            ><span class="mord text mtight"
                              ><span class="mord cjk_fallback mtight">得到</span
                              ><span class="mord mtight"
                                >region&nbsp;proposal</span
                              ></span
                            ></span
                          ></span
                        ></span
                      ><span class="svg-align" style="top: -2.689em"
                        ><span class="pstrut" style="height: 2.7em"></span
                        ><span
                          class="hide-tail"
                          style="height: 0.522em; min-width: 1.469em"
                          ><svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="400em"
                            height="0.522em"
                            viewBox="0 0 400000 522"
                            preserveAspectRatio="xMaxYMin slice"
                          >
                            <path
                              d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"
                            ></path></svg></span></span></span
                    ><span class="vlist-s">​</span></span
                  ><span class="vlist-r"
                    ><span class="vlist" style="height: 0.011em"
                      ><span></span></span></span></span></span></span></span
        ></span>
        用另外一个初始的共享卷积层训练 Fast R-CNN<br />
        <span class="katex"
          ><span class="katex-mathml"
            ><math xmlns="http://www.w3.org/1998/Math/MathML"
              ><semantics
                ><mrow
                  ><mover
                    ><mo stretchy="true" minsize="3.0em">→</mo
                    ><mpadded width="+0.6em" lspace="0.3em"
                      ><mtext>用它的共享卷积层初始化</mtext></mpadded
                    ></mover
                  ></mrow
                ><annotation encoding="application/x-tex"
                  >\xrightarrow{用它的共享卷积层初始化}</annotation
                ></semantics
              ></math
            ></span
          ><span class="katex-html" aria-hidden="true"
            ><span class="base"
              ><span
                class="strut"
                style="height: 1.1113em; vertical-align: -0.011em"
              ></span
              ><span class="mrel x-arrow"
                ><span class="vlist-t vlist-t2"
                  ><span class="vlist-r"
                    ><span class="vlist" style="height: 1.1003em"
                      ><span style="top: -3.322em"
                        ><span class="pstrut" style="height: 2.7em"></span
                        ><span
                          class="sizing reset-size6 size3 mtight x-arrow-pad"
                          ><span class="mord mtight"
                            ><span class="mord cjk_fallback mtight"
                              >用它的共享卷积层初始化</span
                            ></span
                          ></span
                        ></span
                      ><span class="svg-align" style="top: -2.689em"
                        ><span class="pstrut" style="height: 2.7em"></span
                        ><span
                          class="hide-tail"
                          style="height: 0.522em; min-width: 1.469em"
                          ><svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="400em"
                            height="0.522em"
                            viewBox="0 0 400000 522"
                            preserveAspectRatio="xMaxYMin slice"
                          >
                            <path
                              d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"
                            ></path></svg></span></span></span
                    ><span class="vlist-s">​</span></span
                  ><span class="vlist-r"
                    ><span class="vlist" style="height: 0.011em"
                      ><span></span></span></span></span></span></span></span></span
        >保持共享卷积层不变，仅微调 RPN 特有的层
        <span class="katex"
          ><span class="katex-mathml"
            ><math xmlns="http://www.w3.org/1998/Math/MathML"
              ><semantics
                ><mrow
                  ><mover
                    ><mo stretchy="true" minsize="3.0em">→</mo
                    ><mpadded width="+0.6em" lspace="0.3em"
                      ><mrow></mrow></mpadded></mover></mrow
                ><annotation encoding="application/x-tex"
                  >\xrightarrow{}</annotation
                ></semantics
              ></math
            ></span
          ><span class="katex-html" aria-hidden="true"
            ><span class="base"
              ><span
                class="strut"
                style="height: 0.633em; vertical-align: -0.011em"
              ></span
              ><span class="mrel x-arrow"
                ><span class="vlist-t vlist-t2"
                  ><span class="vlist-r"
                    ><span class="vlist" style="height: 0.622em"
                      ><span style="top: -3.144em"
                        ><span class="pstrut" style="height: 2.522em"></span
                        ><span
                          class="sizing reset-size6 size3 mtight x-arrow-pad"
                          ><span class="mord mtight"></span></span></span
                      ><span class="svg-align" style="top: -2.511em"
                        ><span class="pstrut" style="height: 2.522em"></span
                        ><span
                          class="hide-tail"
                          style="height: 0.522em; min-width: 1.469em"
                          ><svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="400em"
                            height="0.522em"
                            viewBox="0 0 400000 522"
                            preserveAspectRatio="xMaxYMin slice"
                          >
                            <path
                              d="M0 241v40h399891c-47.3 35.3-84 78-110 128
-16.7 32-27.7 63.7-33 95 0 1.3-.2 2.7-.5 4-.3 1.3-.5 2.3-.5 3 0 7.3 6.7 11 20
 11 8 0 13.2-.8 15.5-2.5 2.3-1.7 4.2-5.5 5.5-11.5 2-13.3 5.7-27 11-41 14.7-44.7
 39-84.5 73-119.5s73.7-60.2 119-75.5c6-2 9-5.7 9-11s-3-9-9-11c-45.3-15.3-85
-40.5-119-75.5s-58.3-74.8-73-119.5c-4.7-14-8.3-27.3-11-40-1.3-6.7-3.2-10.8-5.5
-12.5-2.3-1.7-7.5-2.5-15.5-2.5-14 0-21 3.7-21 11 0 2 2 10.3 6 25 20.7 83.3 67
 151.7 139 205zm0 0v40h399900v-40z"
                            ></path></svg></span></span></span
                    ><span class="vlist-s">​</span></span
                  ><span class="vlist-r"
                    ><span class="vlist" style="height: 0.011em"
                      ><span></span></span></span></span></span></span></span></span
        >保持共享卷积层不变，仅微调 Fast R-CNN 特有的层
      </p>
      <h3 id="实现细节">实现细节</h3>
      <ul>
        <li>用图像金字塔可以提高精度，但效率和准确率的平衡不好。</li>
        <li>锚点使用三个尺度和三个纵横比，这些超参数并没有精心选择。</li>
        <li>
          训练时超出图像边界的锚框在训练中全部被忽略。如果不忽略，则容易不收敛。测试时产生的超过边界的则被裁切。
        </li>
        <li>
          采用 NMS，阈值为 0.7。NMS 在不损失检测精度的时候大幅减少了 region
          proposal 的数量。
        </li>
      </ul>
    </div>
  </body>
</html>
